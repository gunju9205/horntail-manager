<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í˜¼í…Œì¼ ê³µëŒ€ ê´€ë¦¬ í”Œë«í¼</title>
    
    <style>
      /* --- [ê¸°ë³¸ ì„¤ì •] --- */
      body {
        font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
        margin: 0; padding: 0; color: #333; height: 100vh;
        overflow-x: hidden; 
        background-color: #f0f2f5; 
      }
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

      /* --- [ë¡œë¹„ (ê³µëŒ€ ì„ íƒ)] --- */
      #lobby-view {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #f0f2f5; z-index: 10000;
        display: flex; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box;
        overflow-y: auto;
      }
      .lobby-header { text-align: center; margin-top: 40px; margin-bottom: 30px; }
      .lobby-title { font-size: 28px; font-weight: 800; color: #2c3e50; letter-spacing: -1px; margin-bottom: 5px; }
      .lobby-sub { font-size: 14px; color: #7f8c8d; }
      
      .channel-list { 
        display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; 
        width: 100%; max-width: 900px; 
      }
      .channel-card {
        background: #fff; border-radius: 16px; padding: 20px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee;
        transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;
        display: flex; flex-direction: column; justify-content: space-between;
        min-height: 120px;
      }
      .channel-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); border-color: #ff6b00; }
      .ch-name { font-size: 18px; font-weight: 800; color: #333; margin-bottom: 5px; }
      .ch-info { font-size: 12px; color: #999; }
      .ch-lock { margin-top: 15px; display: flex; justify-content: flex-end; align-items: center; font-size: 12px; color: #ff6b00; font-weight: bold; }
      
      .create-card {
        background: #fdfdfd; border: 2px dashed #ddd; display: flex; align-items: center; justify-content: center;
        color: #999; font-weight: bold; flex-direction: column; gap: 8px;
      }
      .create-card:hover { border-color: #ff6b00; color: #ff6b00; background: #fffcf9; }

      /* --- [ë¡œê·¸ì¸] --- */
      #login-view {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #f0f2f5; z-index: 9999; display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
      }
      .login-card {
        background: #ffffff; padding: 40px 30px; border-radius: 20px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 360px; text-align: center; border: 1px solid #e1e4e8;
      }
      .login-title { color: #ff6b00; font-size: 26px; font-weight: 800; margin-bottom: 30px; letter-spacing: -0.5px; }
      .login-input {
        width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 10px;
        font-size: 15px; outline: none; background: #f9f9f9; transition: all 0.2s; box-sizing: border-box;
      }
      .login-input:focus { border-color: #ff6b00; background: #fff; }
      .login-btn {
        width: 100%; background-color: #ff6b00; color: white; border: none; padding: 16px; border-radius: 10px;
        font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: background 0.2s;
      }
      .login-btn:hover { background-color: #e65c00; }
      .back-to-lobby { margin-top: 15px; color: #999; font-size: 13px; text-decoration: underline; cursor: pointer; }

      /* --- [ë©”ì¸ ë ˆì´ì•„ì›ƒ] --- */
      #main-app { display: none; max-width: 1200px; margin: 0 auto; padding: 20px; box-sizing: border-box; min-height: 100%; padding-bottom: 50px; }
      .header-area {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px 20px;
        background: #ffffff; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #eaeaea;
      }
      .header-title h1 { margin: 0; font-size: 22px; color: #2c3e50; font-weight: 800; letter-spacing: -0.5px; }
      .header-title .subtitle { color: #fff; font-size: 13px; font-weight: bold; background: #ff6b00; padding: 4px 10px; border-radius: 20px; margin-left: 10px; vertical-align: middle; }
      .user-info { font-weight: 600; color: #555; display: flex; align-items: center; gap: 12px; font-size: 14px; }
      .logout-link { font-size: 12px; color: #999; text-decoration: underline; cursor: pointer; }

      .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
      @media (min-width: 900px) { .dashboard-grid { grid-template-columns: 320px 1fr; } }
      @media (max-width: 600px) {
        #main-app { padding: 10px; padding-bottom: 60px; }
        .header-area { flex-direction: column; align-items: flex-start; gap: 10px; padding: 15px; }
        .user-info { width: 100%; justify-content: space-between; border-top: 1px solid #eee; padding-top: 10px; margin-top: 5px; }
        .right-panel { grid-template-columns: repeat(2, 1fr); gap: 10px; } 
        .modal-card { width: 95%; max-height: 90vh; padding: 15px; }
        .party-row { flex-direction: column; align-items: stretch; gap: 10px; text-align: center; }
        .form-row { flex-wrap: wrap; }
        .form-control { width: 100%; }
      }

      /* --- [ì¹´ë“œ ê³µí†µ] --- */
      .tilt-card {
        background: #ffffff; border: 1px solid #eaeaea; border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.03); overflow: hidden; transition: transform 0.1s ease-out, box-shadow 0.2s;
        perspective: 1000px; transform-style: preserve-3d; position: relative;
      }
      .tilt-card:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.06); }

      /* ì¢Œì¸¡ íŒ¨ë„ */
      .left-panel { display: flex; flex-direction: column; height: 100%; min-height: 500px; }
      .panel-header { padding: 18px 20px; border-bottom: 1px solid #f0f0f0; background: #fff; display: flex; justify-content: space-between; align-items: center; }
      .panel-title { font-size: 17px; font-weight: 800; color: #333; }
      .header-btns { display: flex; gap: 8px; }
      .icon-btn { background: #f5f5f5; border: none; cursor: pointer; font-size: 14px; color: #666; width: 34px; height: 34px; border-radius: 10px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
      .icon-btn:hover { background: #ff6b00; color: white; transform: translateY(-2px); }
      #add-member-btn, #reset-party-btn { display: none; }
      .member-list-container { flex: 1; overflow-y: auto; padding: 15px; background: #fafafa; }

      /* íŒŒí‹° ëª©ë¡ ë””ìì¸ */
      .party-header { 
        background: #333; color: #fff; font-weight: 800; font-size: 12px; 
        padding: 6px 12px; margin-top: 20px; margin-bottom: 10px; border-radius: 6px; 
        display: inline-block; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .party-header:first-child { margin-top: 0; }
      
      .member-item { 
        display: flex; justify-content: space-between; align-items: center; 
        padding: 12px 14px; margin-bottom: 8px; background: #ffffff; border-radius: 12px; 
        border: 1px solid #eee; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        position: relative; overflow: hidden;
      }
      .member-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #ddd; }
      .member-item.hero::before { background: #ff4d4f; }
      .member-item.thief::before { background: #52c41a; }
      .member-item.mage::before { background: #1890ff; }
      .member-item.archer::before { background: #faad14; }
      .member-item.dk::before { background: #722ed1; }

      .member-item:hover { transform: translateX(3px); border-color: #ff6b00; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
      .member-info { display: flex; flex-direction: column; }
      .member-name { font-weight: 800; color: #222; font-size: 15px; }
      .member-detail { font-size: 12px; color: #888; margin-top: 2px; font-weight: 500; }
      .member-right { display: flex; align-items: center; gap: 8px; }
      .member-lv { background: #f0f2f5; color: #555; padding: 4px 8px; border-radius: 8px; font-size: 11px; font-weight: 700; border: 1px solid #e1e4e8; }
      .delete-btn { 
        background: #fff1f0; color: #ff4d4f; border: 1px solid #ffa39e; border-radius: 8px; 
        width: 26px; height: 26px; font-size: 14px; font-weight: bold; cursor: pointer; 
        display: flex; align-items: center; justify-content: center; transition: all 0.2s;
      }
      .delete-btn:hover { background: #ff4d4f; color: #fff; }

      /* ìš°ì¸¡ íŒ¨ë„ ë©”ë‰´ */
      .right-panel { display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(4, 1fr); gap: 15px; height: 100%; }
      .menu-btn { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; cursor: pointer; padding: 20px; background: #ffffff; }
      .menu-icon { font-size: 36px; margin-bottom: 12px; display: block; }
      .menu-label { font-size: 16px; font-weight: 700; color: #333; }
      .menu-sub { font-size: 12px; color: #999; margin-top: 6px; font-weight: 500; }
      .highlight-text { color: #ff6b00 !important; }

      /* --- [ëª¨ë‹¬ ê³µí†µ] --- */
      .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
      .modal-card { background: #ffffff; width: 98%; max-width: 1000px; border-radius: 20px; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); animation: slideUp 0.25s ease-out; position: relative; }
      @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
      .modal-title { font-size: 20px; font-weight: 800; color: #333; }
      .close-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: #ccc; }
      .modal-body { max-height: 80vh; overflow-y: auto; font-size: 14px; line-height: 1.6; }

      .form-group { margin-bottom: 12px; }
      .form-label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: #555; }
      .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 13px; box-sizing: border-box; background: #fff; }
      .form-control:focus { border-color: #ff6b00; outline: none; }
      .form-control[readonly] { background-color: #f9f9f9; color: #666; font-weight: bold; }
      .form-row { display: flex; gap: 8px; align-items: center; }
      .form-submit-btn { width: 100%; background: #ff6b00; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 14px; }
      .form-submit-btn:hover { background: #e65c00; }

      /* í…Œì´ë¸” ëª¨ë°”ì¼ ëŒ€ì‘ (ìŠ¤í¬ë¡¤) */
      .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 10px; border: 1px solid #eee; border-radius: 8px; }
      .record-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 0; min-width: 500px; }
      .record-table th { background: #f8f9fa; padding: 10px 8px; text-align: center; border-bottom: 1px solid #ddd; font-weight: 600; color: #555; white-space: nowrap;}
      .record-table td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: center; color: #333; vertical-align: middle; }
      .record-empty { text-align: center; padding: 20px; color: #aaa; font-style: italic; }
      .action-btn { border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px; margin: 0 1px; font-weight: bold; }
      .btn-del { background: #fff1f0; color: #f5222d; }
      .btn-pay { background: #e6f7ff; color: #1890ff; }

      /* --- [êµ¬ê¸€ ìº˜ë¦°ë” ìŠ¤íƒ€ì¼] --- */
      .calendar-container { background: #fff; border-radius: 12px; border: 1px solid #e0e0e0; overflow: hidden; }
      .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: #e0e0e0; gap: 1px; }
      .calendar-header { background: #f8f9fa; padding: 10px; font-weight: bold; text-align: center; font-size: 13px; color: #70757a; }
      .calendar-day { background: #fff; min-height: 80px; padding: 4px; cursor: pointer; transition: background 0.2s; position: relative; }
      .calendar-day:hover { background: #f1f3f4; }
      .day-num { font-size: 12px; font-weight: 600; margin-bottom: 4px; display: block; color: #3c4043; text-align: center; }
      .leave-badge { background: #1a73e8; color: white; font-size: 10px; padding: 2px 4px; border-radius: 4px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; font-weight: 500; cursor: pointer; }
      .leave-badge:hover { opacity: 0.8; }
      .leave-badge.admin { background: #d93025; }
      .today-cell { background: #f8f9ff !important; }
      .today-cell .day-num { background: #1a73e8; color: white; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; }

      /* ëŒ€ê¸°ì‹¤/íŒŒí‹° í¸ì„± ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
      .pool-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; background: #f8f9fa; padding: 15px; border-radius: 16px; border: 1px solid #eee; margin-bottom: 20px; max-height: 300px; overflow-y: auto; }
      .pool-chip { 
        position: relative; padding: 10px 4px; border-radius: 12px; border: 2px solid transparent; 
        background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; 
        justify-content: center; gap: 4px; min-height: 80px; transition: all 0.2s; box-shadow: 0 4px 8px rgba(0,0,0,0.03); 
      }
      .pool-chip:hover { transform: translateY(-3px); }
      .pool-chip.selected { border-color: #ff6b00; background: #fffcf5; transform: scale(0.96); box-shadow: inset 0 0 10px rgba(255,107,0,0.05); }
      .pool-chip .chip-name { font-weight: 800; font-size: 13px; color: #222; text-align: center; word-break: keep-all; }
      .pool-chip .chip-sub { font-size: 11px; font-weight: 600; color: #777; }
      
      .pool-chip.bg-hero { border-bottom: 4px solid #ff4d4f; }
      .pool-chip.bg-thief { border-bottom: 4px solid #52c41a; }
      .pool-chip.bg-archer { border-bottom: 4px solid #faad14; }
      .pool-chip.bg-dk { border-bottom: 4px solid #722ed1; }
      .pool-chip.bg-mage { border-bottom: 4px solid #1890ff; }

      .party-row { 
        background: #fdfdfd; border: 1px solid #eee; border-radius: 12px; padding: 12px 20px; 
        margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;
        transition: all 0.2s;
      }
      .party-row:hover { background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
      .party-label { font-weight: 800; font-size: 17px; color: #333; }
      
      .party-add-btn { 
        background: #f0f0f0; color: #999; border: none; padding: 10px 20px; border-radius: 10px; 
        font-weight: 800; cursor: not-allowed; transition: all 0.2s; font-size: 14px;
      }
      .party-add-btn.active { 
        background: #333; color: white; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
      }
      .party-add-btn.active:hover { transform: translateY(-2px); background: #ff6b00; }
      .party-add-btn.active:active { transform: translateY(0); }

      /* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      .tab-container { 
        display: flex; background: #f1f3f5; border-radius: 12px; padding: 4px; margin-bottom: 20px; border: none; 
      }
      .tab-btn { 
        flex: 1; padding: 10px; border: none; border-radius: 8px; 
        font-weight: 700; color: #888; cursor: pointer; font-size: 14px; 
        transition: all 0.2s; background: transparent; 
      }
      .tab-btn.active { 
        background: #fff; color: #ff6b00; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
      }

      /* --- [ë¶„ë°°ê¸ˆ ê´€ë¦¬ ìŠ¤íƒ€ì¼] --- */
      .dist-layout { display: flex; flex-direction: column; gap: 20px; }
      .dist-panel { background: #fff; border-radius: 12px; border: 1px solid #eee; padding: 20px; }
      .dist-title { font-weight: 800; font-size: 16px; margin-bottom: 12px; color: #333; border-left: 4px solid #ff6b00; padding-left: 10px; }
      .dist-member-pool { display: flex; flex-wrap: wrap; gap: 6px; padding: 10px; background: #fcfcfc; border: 1px solid #eee; border-radius: 8px; max-height: 150px; overflow-y: auto; margin-bottom: 10px; }
      .dist-chip { padding: 6px 12px; background: #fff; border: 1px solid #ddd; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.2s; user-select: none; color: #555; }
      .dist-chip.selected { background: #ff6b00; color: white; border-color: #ff6b00; font-weight: bold; box-shadow: 0 2px 6px rgba(255,107,0,0.2); }
      .balance-plus { color: #52c41a; font-weight: bold; }
      .balance-zero { color: #ccc; }

      /* --- [í† ìŠ¤íŠ¸] --- */
      #save-toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 14px; opacity: 0; transition: opacity 0.5s; z-index: 10000; pointer-events: none; }
      #save-toast.show { opacity: 1; }
    </style>
  </head>
  <body>

    <!-- [0] ë¡œë¹„ (ì±„ë„ ì„ íƒ) -->
    <div id="lobby-view">
      <div class="lobby-header">
        <div class="lobby-title">ë©”ì´í”ŒìŠ¤í† ë¦¬ ê³µëŒ€ ê´€ë¦¬</div>
        <div class="lobby-sub">í•¨ê»˜í•˜ëŠ” ì¦ê±°ì›€, í¸ë¦¬í•œ ì •ì‚°</div>
      </div>
      
      <div id="channel-list" class="channel-list">
        <!-- ì±„ë„ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
      </div>
      
      <div class="channel-card create-card" onclick="openCreateModal()">
        <span style="font-size:30px;">+</span>
        <span>ìƒˆë¡œìš´ ê³µëŒ€ ë§Œë“¤ê¸°</span>
      </div>
    </div>

    <!-- [1] ë¡œê·¸ì¸ -->
    <div id="login-view">
      <div class="login-card tilt-card" data-tilt>
        <div class="login-title" id="login-channel-name">ê³µëŒ€ ë¡œê·¸ì¸</div>
        <input type="text" id="login-nick" class="login-input" placeholder="ìºë¦­í„°ëª… (ê´€ë¦¬ìëŠ” 'ê´€ë¦¬ì')">
        <input type="password" id="login-pw" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="handleEnter(event)">
        <button class="login-btn" onclick="tryLogin()">ì ‘ì†í•˜ê¸°</button>
        <div class="back-to-lobby" onclick="location.reload()">â† ë‹¤ë¥¸ ê³µëŒ€ ì„ íƒí•˜ê¸°</div>
      </div>
    </div>

    <!-- [2] ë©”ì¸ ì•± (ê¸°ì¡´ê³¼ ë™ì¼) -->
    <div id="main-app">
      <div class="header-area">
        <div class="header-title">
          <h1><span id="app-guild-name">ì‹œëŒ€ ê¸¸ë“œ</span> <span class="subtitle">ê³µëŒ€ ê´€ë¦¬ ì‹œìŠ¤í…œ</span></h1>
        </div>
        <div class="user-info">
          <span id="role-badge" style="font-size:11px; padding:2px 6px; border-radius:4px; margin-right:5px; color:white; font-weight:bold;"></span>
          <span id="user-display"></span>ë‹˜
          <span class="logout-link" onclick="location.reload()">(ë¡œê·¸ì•„ì›ƒ)</span>
        </div>
      </div>

      <div class="dashboard-grid">
        <!-- ì¢Œì¸¡: ëŒ€ì› ëª…ë‹¨ -->
        <div class="left-panel tilt-card" data-tilt>
          <div class="panel-header">
            <span class="panel-title">ğŸ›¡ï¸ ì˜¤ëŠ˜ì˜ íŒŒí‹° ëª…ë‹¨</span>
            <div class="header-btns">
              <button id="add-member-btn" class="icon-btn" onclick="openAddMemberModal()" title="íŒŒí‹° í¸ì„±">â•</button>
              <button id="reset-party-btn" class="icon-btn" onclick="resetParty()" title="íŒŒí‹° ì´ˆê¸°í™”">ğŸ—‘ï¸</button>
              <button class="icon-btn" onclick="loadMembers()" title="ìƒˆë¡œê³ ì¹¨">â†»</button>
            </div>
          </div>
          <div id="member-list-container" class="member-list-container">
            <div style="text-align:center; padding:20px; color:#999;">ë¡œë”© ì¤‘...</div>
          </div>
        </div>

        <!-- ìš°ì¸¡: ë©”ë‰´ -->
        <div class="right-panel">
          <div class="menu-btn tilt-card" data-tilt onclick="openChannelHistory()">
            <span class="menu-icon">ğŸ“¢</span><span class="menu-label">ì˜¤ëŠ˜ì˜ ì±„ë„</span><span class="menu-sub">ë¦¬í”„ë ˆ / ì›ì •ëŒ€</span>
          </div>
          <div class="menu-btn tilt-card" data-tilt onclick="openEntryTimeHistory()">
            <span class="menu-icon">â°</span><span class="menu-label">ì…ì¥ ì‹œê°„</span><span class="menu-sub">ì•Œë²„í”„ / ì˜ë©”</span>
          </div>
          <div class="menu-btn tilt-card" data-tilt onclick="openGuestHistory()">
            <span class="menu-icon">ğŸ«</span><span class="menu-label">ì†ë‹˜ ì •ë³´</span><span class="menu-sub">ì˜ˆì•½ ë° êµ¬ë§¤</span>
          </div>
          <div class="menu-btn tilt-card" data-tilt onclick="openMultiTimer()">
            <span class="menu-icon">â±ï¸</span><span class="menu-label">ë ˆì´ë“œ íƒ€ì´ë¨¸</span><span class="menu-sub">ë¦¬ì €/ê³µë¬´/í•´ì œ</span>
          </div>
          <div class="menu-btn tilt-card" data-tilt onclick="openLeaveCalendar()">
            <span class="menu-icon">ğŸ“…</span><span class="menu-label">ì—°ì°¨ ì‹ ì²­</span><span class="menu-sub">êµ¬ê¸€ ìº˜ë¦°ë” ìŠ¤íƒ€ì¼</span>
          </div>
          <div class="menu-btn tilt-card" data-tilt onclick="openLootHistory()">
            <span class="menu-icon">ğŸ’</span><span class="menu-label">ì „ë¦¬í’ˆ ì •ë³´</span><span class="menu-sub">ë§ˆìŠ¤í„°ë¦¬ë¶ / ì¥ë¹„</span>
          </div>
          <div class="menu-btn tilt-card" data-tilt onclick="openDistributionHistory()">
            <span class="menu-icon">ğŸ’¸</span><span class="menu-label highlight-text">ë¶„ë°°ê¸ˆ ì •ë³´</span><span class="menu-sub">ìˆ˜ìˆ˜ë£Œ ìë™ ê³„ì‚° & ì •ì‚°</span>
          </div>
          <div class="menu-btn tilt-card" data-tilt onclick="openGuestReviews()">
            <span class="menu-icon">â­</span><span class="menu-label">ì†ë‹˜ ë¦¬ë·°</span><span class="menu-sub">í›„ê¸° ë° ì¸ì¦ìƒ·</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ëª¨ë‹¬: ê³µí†µ -->
    <div id="modal-overlay" class="modal-overlay" onclick="closeModal(event)">
      <div class="modal-card">
        <div class="modal-header">
          <span id="modal-title" class="modal-title">ì œëª©</span>
          <button class="close-btn" onclick="document.getElementById('modal-overlay').style.display='none'">&times;</button>
        </div>
        <div class="modal-body">
          <div id="modal-content"></div>
        </div>
      </div>
    </div>

    <!-- ëª¨ë‹¬: ê³µëŒ€ ìƒì„± ì „ìš© -->
    <div id="create-channel-modal" class="modal-overlay" onclick="if(event.target.id==='create-channel-modal') this.style.display='none'">
      <div class="modal-card" style="max-width:400px;">
        <div class="modal-header">
          <span class="modal-title">âœ¨ ìƒˆë¡œìš´ ê³µëŒ€ ìƒì„±</span>
          <button class="close-btn" onclick="document.getElementById('create-channel-modal').style.display='none'">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">ê³µëŒ€ ì´ë¦„</label>
            <input type="text" id="new-ch-name" class="form-control" placeholder="ì˜ˆ: ë¬´ì ê³µëŒ€">
          </div>
          <div class="form-group">
            <label class="form-label">ì±„ë„ ì ‘ì† ë¹„ë°€ë²ˆí˜¸</label>
            <input type="text" id="new-ch-pw" class="form-control" placeholder="ê³µëŒ€ì›ë“¤ì—ê²Œ ê³µìœ í•  ë¹„ë²ˆ">
          </div>
          <div class="form-group" style="margin-top:20px; border-top:1px dashed #ddd; padding-top:10px;">
            <label class="form-label" style="color:#ff6b00;">ğŸ” ë§ˆìŠ¤í„° í‚¤ (ìƒì„± ìŠ¹ì¸ìš©)</label>
            <input type="password" id="master-key-input" class="form-control" placeholder="ê´€ë¦¬ì ìŠ¹ì¸ ì•”í˜¸">
          </div>
          <button class="form-submit-btn" onclick="createNewChannel()">ê³µëŒ€ ìƒì„±í•˜ê¸°</button>
        </div>
      </div>
    </div>

    <!-- ëª¨ë‹¬: íŒŒí‹° í¸ì„± ì „ìš© -->
    <div id="add-member-modal" class="modal-overlay" onclick="closeAddModal(event)">
      <div class="modal-card" style="max-width:600px;">
        <div class="modal-header">
          <span class="modal-title">ğŸ› ï¸ íŒŒí‹° í¸ì„± ê´€ë¦¬ ì„¼í„°</span>
          <button class="close-btn" onclick="document.getElementById('add-member-modal').style.display='none'">&times;</button>
        </div>
        <div class="modal-body">
          <div class="tab-container">
            <button class="tab-btn active" id="tab-btn-pick" onclick="switchAddTab('pick')">ê°„í¸ í¸ì„±</button>
            <button class="tab-btn" id="tab-btn-single" onclick="switchAddTab('single')">ì‹ ê·œ ë“±ë¡</button>
          </div>
          <div id="tab-content-pick">
            <div style="font-size:13px; color:#666; margin-bottom:8px; font-weight:bold;">1ë‹¨ê³„: ëŒ€ê¸°ì‹¤ ë©¤ë²„ ì„ íƒ</div>
            <div id="pool-container" class="pool-container"></div>
            <div style="font-size:13px; color:#666; margin-bottom:12px; font-weight:bold; margin-top:20px;">2ë‹¨ê³„: ëª©í‘œ íŒŒí‹° ì§€ì •</div>
            <div class="party-row">
                <span class="party-label">1íŒŒí‹° (ì›ì •ëŒ€)</span>
                <button class="party-add-btn" id="btn-p1" onclick="addSelectedToParty('1íŒŒí‹°')">+ ì…ì¥ì‹œí‚¤ê¸°</button>
            </div>
            <div class="party-row">
                <span class="party-label">2íŒŒí‹°</span>
                <button class="party-add-btn" id="btn-p2" onclick="addSelectedToParty('2íŒŒí‹°')">+ ì…ì¥ì‹œí‚¤ê¸°</button>
            </div>
            <div class="party-row">
                <span class="party-label">3íŒŒí‹°</span>
                <button class="party-add-btn" id="btn-p3" onclick="addSelectedToParty('3íŒŒí‹°')">+ ì…ì¥ì‹œí‚¤ê¸°</button>
            </div>
            <div class="party-row">
                <span class="party-label">ëŒ€ê¸°ì ëª…ë‹¨</span>
                <button class="party-add-btn" id="btn-pw" onclick="addSelectedToParty('ëŒ€ê¸°')">+ ì…ì¥ì‹œí‚¤ê¸°</button>
            </div>
          </div>
          <div id="tab-content-single" style="display:none; padding:10px;">
            <div class="form-group">
                <label class="form-label">ìºë¦­í„° ë‹‰ë„¤ì„</label>
                <input type="text" id="new-nick" class="form-control" placeholder="ì¸ê²Œì„ ë‹‰ë„¤ì„">
            </div>
            <div class="form-group">
                <label class="form-label">ì§ì—… ì„ íƒ</label>
                <select id="new-job" class="form-control">
                    <option value="íˆì–´ë¡œ">íˆì–´ë¡œ</option><option value="ë‚˜ì´íŠ¸ë¡œë“œ">ë‚˜ì´íŠ¸ë¡œë“œ</option>
                    <option value="ë¹„ìˆ">ë¹„ìˆ</option><option value="ë³´ìš°ë§ˆìŠ¤í„°">ë³´ìš°ë§ˆìŠ¤í„°</option>
                    <option value="ë‹¤í¬ë‚˜ì´íŠ¸">ë‹¤í¬ë‚˜ì´íŠ¸</option><option value="ì„€ë„ì–´">ì„€ë„ì–´</option>
                    <option value="ì‹ ê¶">ì‹ ê¶</option><option value="ìº¡í‹´">ìº¡í‹´</option><option value="ë°”ì´í¼">ë°”ì´í¼</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">ë ˆë²¨</label>
                <input type="number" id="new-level" class="form-control" placeholder="120">
            </div>
            <button class="form-submit-btn" onclick="submitNewMember()">ëŒ€ê¸°ì‹¤(ëª…ë¶€)ì— ë“±ë¡</button>
          </div>
        </div>
      </div>
    </div>

    <div id="save-toast">â˜ï¸ ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ</div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, doc, setDoc, getDocs, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // =========================================================================
      // [Firebase ì„¤ì •]
      // =========================================================================
      const myFirebaseConfig = {
        apiKey: "AIzaSyAUdwSO5XwI6xODntL2aypZEUShW0kVThI",
        authDomain: "sidae-guild-horntail.firebaseapp.com",
        projectId: "sidae-guild-horntail",
        storageBucket: "sidae-guild-horntail.firebasestorage.app",
        messagingSenderId: "494207905469",
        appId: "1:494207905469:web:bfacf66949995eaa6391d4"
      };
      
      // [ì¤‘ìš”] ê³µëŒ€ ìƒì„± ìŠ¹ì¸ìš© ë§ˆìŠ¤í„° í‚¤ (ì›í•˜ëŠ” ì•”í˜¸ë¡œ ë³€ê²½í•˜ì„¸ìš”)
      const MASTER_CREATION_KEY = "admin1234"; 
      
      const ROOT_APP_ID = "raid-platform-v1"; // í”Œë«í¼ ID (ê³ ì •)
      // =========================================================================

      window.sysConfig = { pwAdmin: '9999', pwMember: '0000', pwGuest: '7777' };
      window.currentUser = "";
      window.userRole = "";
      window.isAdmin = false;
      window.currentChannelId = ""; // í˜„ì¬ ì ‘ì†ì¤‘ì¸ ê³µëŒ€ ID
      
      // ì•± ë°ì´í„° ì´ˆê¸°ê°’
      const initialAppData = { channel: [], entry: [], guest: [], loot: [], leaves: [], distribution: [], payouts: [], reviews: [] };
      window.appData = JSON.parse(JSON.stringify(initialAppData));
      window.localMembers = [];
      window.allMembers = [];
      window.selectedNicks = [];
      window.selectedDistMembers = [];

      let db, auth;

      (async function init() {
        const app = initializeApp(myFirebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        await signInAnonymously(auth);
        onAuthStateChanged(auth, (user) => { 
          if(user) {
            loadChannelList(); // ë¡œê·¸ì¸ ë˜ë©´ ë¡œë¹„ ëª©ë¡ ë¡œë“œ
          }
        });
      })();

      // --- [ë¡œë¹„ & ì±„ë„ ë¡œì§] ---
      
      // ì±„ë„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
      async function loadChannelList() {
        const listDiv = document.getElementById('channel-list');
        listDiv.innerHTML = '<div style="text-align:center; padding:20px;">ê³µëŒ€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        
        try {
          // 'raid_channels' ì»¬ë ‰ì…˜ì—ì„œ ëª¨ë“  ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸°
          const querySnapshot = await getDocs(collection(db, 'artifacts', ROOT_APP_ID, 'public', 'data', 'raid_channels'));
          
          if(querySnapshot.empty) {
             listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">ìƒì„±ëœ ê³µëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²« ê³µëŒ€ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!</div>';
             return;
          }

          let html = '';
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            html += `
            <div class="channel-card" onclick="enterChannel('${doc.id}', '${data.password}', '${data.name}')">
              <div>
                <div class="ch-name">${data.name}</div>
                <div class="ch-info">ID: ${doc.id}</div>
              </div>
              <div class="ch-lock">ğŸ”’ ë¹„ê³µê°œ ì±„ë„</div>
            </div>`;
          });
          listDiv.innerHTML = html;
        } catch (e) {
          console.error(e);
          listDiv.innerHTML = 'ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨';
        }
      }

      window.openCreateModal = function() {
        document.getElementById('create-channel-modal').style.display = 'flex';
      }

      window.createNewChannel = async function() {
        const name = document.getElementById('new-ch-name').value.trim();
        const pw = document.getElementById('new-ch-pw').value.trim();
        const key = document.getElementById('master-key-input').value.trim();

        if(!name || !pw) return alert('ê³µëŒ€ ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        if(key !== MASTER_CREATION_KEY) return alert('ë§ˆìŠ¤í„° í‚¤(ìŠ¹ì¸ ì•”í˜¸)ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');

        const newId = 'raid_' + Date.now(); // ìœ ë‹ˆí¬ ID ìƒì„±
        
        try {
          const docRef = doc(db, 'artifacts', ROOT_APP_ID, 'public', 'data', 'raid_channels', newId);
          await setDoc(docRef, {
            name: name,
            password: pw,
            // ì´ˆê¸° ë°ì´í„° ì„¸íŒ…
            records: JSON.stringify(initialAppData),
            pool: JSON.stringify([]),
            members: JSON.stringify([])
          });
          
          alert(`[${name}] ê³µëŒ€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\nì´ì œ ëª©ë¡ì—ì„œ ì ‘ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
          document.getElementById('create-channel-modal').style.display = 'none';
          loadChannelList();
        } catch(e) {
          alert('ìƒì„± ì‹¤íŒ¨: ' + e.message);
        }
      }

      window.enterChannel = async function(id, truePw, name) {
        const inputPw = prompt(`[${name}] ê³µëŒ€ì— ì ‘ì†í•˜ë ¤ë©´\nì±„ë„ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`);
        if(inputPw !== truePw) return alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');

        window.currentChannelId = id; // ì ‘ì†í•œ ì±„ë„ ID ì €ì¥
        document.getElementById('login-channel-name').innerText = name + " ë¡œê·¸ì¸";
        document.getElementById('app-guild-name').innerText = name; // ì•± ìƒë‹¨ ì œëª© ë³€ê²½
        
        // í•´ë‹¹ ì±„ë„ì˜ ë°ì´í„° ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        setupChannelListener(id);
        
        // í™”ë©´ ì „í™˜: ë¡œë¹„ -> ë¡œê·¸ì¸
        document.getElementById('lobby-view').style.display = 'none';
        document.getElementById('login-view').style.display = 'flex';
      }

      function setupChannelListener(channelId) {
        const docRef = doc(db, 'artifacts', ROOT_APP_ID, 'public', 'data', 'raid_channels', channelId);
        onSnapshot(docRef, (snap) => {
          if(snap.exists()){
            const d = snap.data();
            if(d.records) window.appData = JSON.parse(d.records);
            if(d.pool) window.allMembers = JSON.parse(d.pool);
            if(d.members) window.localMembers = JSON.parse(d.members);
            refreshUI();
          }
        });
      }

      // --- [ì €ì¥ ë¡œì§ (í˜„ì¬ ì ‘ì†í•œ ì±„ë„ì— ì €ì¥)] ---
      window.saveAllData = async function() {
        if(!window.currentChannelId) return;
        
        const docRef = doc(db, 'artifacts', ROOT_APP_ID, 'public', 'data', 'raid_channels', window.currentChannelId);
        // ê¸°ì¡´ ì´ë¦„ê³¼ ë¹„ë²ˆì€ ìœ ì§€í•˜ë©´ì„œ ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸í•˜ê¸° ìœ„í•´ merge ì˜µì…˜ ì‚¬ìš© (í•˜ì§€ë§Œ setDoc êµ¬ì¡°ìƒ í•„ë“œë§Œ ë³´ë‚´ë„ ë¨)
        // ì—¬ê¸°ì„œëŠ” ì•ˆì „í•˜ê²Œ ì „ì²´ êµ¬ì¡°ì— ë§ì¶° ì—…ë°ì´íŠ¸
        await setDoc(docRef, {
          records: JSON.stringify(window.appData),
          pool: JSON.stringify(window.allMembers),
          members: JSON.stringify(window.localMembers)
        }, { merge: true }); // merge: true ì¤‘ìš” (ì´ë¦„/ë¹„ë²ˆ ë‚ ì•„ê°€ì§€ ì•Šê²Œ)
        
        document.getElementById('save-toast').classList.add('show');
        setTimeout(()=>document.getElementById('save-toast').classList.remove('show'), 2000);
      }

      function refreshUI() {
        if(document.getElementById('main-app').style.display==='block') {
            loadMembers();
            if(document.getElementById('gu-tb')) renGu();
            if(document.getElementById('lo-tb')) renLo();
            if(document.getElementById('en-tb')) renEn();
            if(document.getElementById('ch-tb')) renCh();
            if(document.getElementById('dist-layout')) renderDistStatus();
        }
      }

      // --- [ê¸°ì¡´ ê¸°ëŠ¥ë“¤ (ìœ ì§€)] ---
      
      /* [ë¶„ë°°ê¸ˆ ê´€ë¦¬] */
      window.openDistributionHistory = function() {
        if(!window.appData.distribution) window.appData.distribution = [];
        if(!window.appData.payouts) window.appData.payouts = [];
        const d = getTodayStr();
        let html = `
        <div id="dist-layout" class="dist-layout">
          <div class="dist-panel">
            <div class="dist-title">ğŸ’° ìˆ˜ì… ë“±ë¡</div>
            ${window.isAdmin ? `
            <div class="form-group">
              <div class="form-row" style="margin-bottom:8px">
                <input type="date" id="ds-d" class="form-control" value="${d}" style="width:130px">
                <input type="text" id="ds-item" class="form-control" placeholder="í’ˆëª©" style="flex:1">
              </div>
              <div class="form-row" style="margin-bottom:8px">
                <input type="number" id="ds-amt" class="form-control" placeholder="ê¸ˆì•¡" oninput="calcDistFee()" style="flex:1">
                <select id="ds-type" class="form-control" onchange="calcDistFee()" style="width:140px">
                  <option value="trade">ì¼ë°˜</option><option value="99">99ìˆ˜ì‘</option><option value="499">499ìˆ˜ì‘</option>
                  <option value="999">999ìˆ˜ì‘</option><option value="2499">2499ìˆ˜ì‘</option><option value="parcel">íƒë°°</option>
                </select>
              </div>
              <div class="form-row" style="margin-bottom:12px">
                <label style="font-size:13px; font-weight:bold;">ìˆœìˆ˜ìµ:</label>
                <input type="text" id="ds-net" class="form-control" readonly style="flex:1; text-align:right; font-weight:bold; color:#ff6b00;">
              </div>
              <label class="form-label">ë¶„ë°° ëŒ€ìƒ (<span id="sel-count">0</span>ëª…)</label>
              <div id="dist-member-pool" class="dist-member-pool"></div>
              <button class="form-submit-btn" onclick="addDistIncome()">ë“±ë¡</button>
            </div>
            ` : '<div style="text-align:center;color:#999;padding:20px;">ê´€ë¦¬ì ì „ìš©</div>'}
          </div>
          <div class="dist-panel">
            <div class="dist-title">ğŸ“Š ì •ì‚° í˜„í™©</div>
            <div class="table-wrapper"><table class="record-table"><thead><tr><th>ì´ë¦„</th><th>ì´ë¶„ë°°</th><th>ì§€ê¸‰ë¨</th><th>ì”ì•¡</th><th>ê´€ë¦¬</th></tr></thead><tbody id="dist-status-tb"></tbody></table></div>
          </div>
          <div class="dist-panel">
            <div class="dist-title">ğŸ’¸ ì§€ê¸‰ ì²˜ë¦¬</div>
            ${window.isAdmin ? `
            <div class="form-group"><div class="form-row">
                <input type="date" id="pay-d" class="form-control" value="${d}" style="width:120px">
                <input type="text" id="pay-to" class="form-control" placeholder="ëŒ€ìƒ" style="width:80px">
                <input type="number" id="pay-amt" class="form-control" placeholder="ê¸ˆì•¡" style="flex:1">
                <button class="action-btn btn-edit" onclick="addDistPayout()">ì§€ê¸‰</button>
            </div></div>` : ''}
            <div style="font-size:12px;margin-top:10px;">ë¡œê·¸</div>
            <div style="max-height:200px;overflow-y:auto;border:1px solid #eee;"><table class="record-table"><tbody id="dist-log-tb"></tbody></table></div>
          </div>
        </div>`;
        showContent('ğŸ’° ë¶„ë°°ê¸ˆ ê´€ë¦¬', html);
        if(window.isAdmin) renderDistMemberPool();
        renderDistStatus();
      }

      window.calcDistFee = function() {
        const amt = parseInt(document.getElementById('ds-amt').value)||0; const type = document.getElementById('ds-type').value; let rate=0;
        if(type==='trade'){ if(amt>=100000000)rate=0.06; else if(amt>=25000000)rate=0.05; else if(amt>=10000000)rate=0.04; else if(amt>=5000000)rate=0.03; else if(amt>=1000000)rate=0.018; else if(amt>=100000)rate=0.008; }
        else if(type==='parcel'){ if(amt>=100000000)rate=0.07; else if(amt>=25000000)rate=0.06; else if(amt>=10000000)rate=0.05; else if(amt>=5000000)rate=0.04; else if(amt>=1000000)rate=0.027; else if(amt>=100000)rate=0.012; }
        else { if(type==='99')rate=0.008; else if(type==='499')rate=0.018; else if(type==='999')rate=0.03; else if(type==='2499')rate=0.04; }
        const net = amt - Math.floor(amt*rate);
        document.getElementById('ds-net').value = net.toLocaleString(); document.getElementById('ds-net').dataset.val = net;
      }
      window.renderDistMemberPool = function() {
        const c=document.getElementById('dist-member-pool'); if(!c)return;
        c.innerHTML = window.allMembers.map(m=>`<div class="dist-chip ${window.selectedDistMembers.includes(m.nick)?'selected':''}" onclick="toggleDistTarget('${m.nick}')">${m.nick}</div>`).join('');
        document.getElementById('sel-count').innerText = window.selectedDistMembers.length;
      }
      window.toggleDistTarget = function(n) { const i=window.selectedDistMembers.indexOf(n); if(i>-1)window.selectedDistMembers.splice(i,1); else window.selectedDistMembers.push(n); renderDistMemberPool(); }
      window.addDistIncome = function() {
        const d=document.getElementById('ds-d').value, item=document.getElementById('ds-item').value, amt=document.getElementById('ds-amt').value, net=document.getElementById('ds-net').dataset.val;
        if(!item||!amt) return alert('ì…ë ¥ í™•ì¸'); if(window.selectedDistMembers.length===0) return alert('ëŒ€ìƒ ì„ íƒ');
        window.appData.distribution.unshift({date:d, item:item, amt:amt, net:parseInt(net), targets:[...window.selectedDistMembers]});
        window.selectedDistMembers=[]; saveAllData(); renderDistMemberPool(); renderDistStatus();
      }
      window.addDistPayout = function() {
        const d=document.getElementById('pay-d').value, to=document.getElementById('pay-to').value, amt=document.getElementById('pay-amt').value;
        if(!to||!amt) return alert('í™•ì¸');
        window.appData.payouts.unshift({date:d, to:to, amt:parseInt(amt)}); document.getElementById('pay-amt').value=''; saveAllData(); renderDistStatus();
      }
      window.setPayTarget = function(n,b) { document.getElementById('pay-to').value=n; document.getElementById('pay-amt').value=b>0?b:''; }
      window.renderDistStatus = function() {
        const bal={}; window.allMembers.forEach(m=>bal[m.nick]={e:0,p:0});
        window.appData.distribution.forEach(d=>{ if(d.targets&&d.targets.length){ const s=Math.floor(d.net/d.targets.length); d.targets.forEach(n=>{ if(!bal[n])bal[n]={e:0,p:0}; bal[n].e+=s; }); }});
        window.appData.payouts.forEach(p=>{ if(!bal[p.to])bal[p.to]={e:0,p:0}; bal[p.to].p+=p.amt; });
        const tb=document.getElementById('dist-status-tb');
        if(tb) {
            tb.innerHTML = Object.keys(bal).sort().map(n=>{
                const b=bal[n], r=b.e-b.p; if(b.e===0&&b.p===0)return '';
                const btn = window.isAdmin&&r>0 ? `<button class="action-btn btn-pay" onclick="setPayTarget('${n}',${r})">ì •ì‚°</button>` : '-';
                return `<tr><td>${n}</td><td style="color:#1890ff">+${b.e.toLocaleString()}</td><td style="color:#555">-${b.p.toLocaleString()}</td><td style="font-weight:bold;color:${r>0?'#ff6b00':'#bbb'}">${r.toLocaleString()}</td><td>${btn}</td></tr>`;
            }).join('') || '<tr><td colspan="5" class="record-empty">ë‚´ì—­ ì—†ìŒ</td></tr>';
        }
        const lb=document.getElementById('dist-log-tb');
        if(lb) {
            const logs=[]; 
            window.appData.distribution.forEach((d,i)=>logs.push({d:d.date,m:`[ìˆ˜ì…] ${d.item} (${d.net.toLocaleString()})`,t:'inc',i:i}));
            window.appData.payouts.forEach((p,i)=>logs.push({d:p.date,m:`[ì§€ê¸‰] ${p.to} ${p.amt.toLocaleString()}`,t:'pay',i:i}));
            logs.sort((a,b)=>b.d.localeCompare(a.d));
            lb.innerHTML = logs.slice(0,50).map(l=>`<tr><td style="font-size:11px;color:#888;">${l.d}</td><td style="text-align:left;">${l.m}</td><td>${window.isAdmin?`<button class="action-btn btn-del" onclick="deleteDistLog('${l.t}',${l.i})">Ã—</button>`:''}</td></tr>`).join('');
        }
      }
      window.deleteDistLog = function(t,i){ if(confirm('ì‚­ì œ?')){ if(t==='inc')window.appData.distribution.splice(i,1); else window.appData.payouts.splice(i,1); saveAllData(); renderDistStatus(); }}

      /* [ê¸°íƒ€ ì¹´í…Œê³ ë¦¬] */
      window.openChannelHistory = () => { showContent('ğŸ“¢ ì˜¤ëŠ˜ì˜ ì±„ë„', `<div class="table-wrapper">${genTable('ch-tb',['ë‚ ì§œ','ë¦¬í”„ë ˆ','ì›ì •ëŒ€','ê´€ë¦¬'])}</div>` + (window.isAdmin?`<div class="form-group"><div class="form-row"><input type="date" id="ch-d" class="form-control" value="${getTodayStr()}"><input type="text" id="ch-v1" class="form-control" placeholder="ë¦¬í”„ë ˆ"><input type="text" id="ch-v2" class="form-control" placeholder="ì›ì •ëŒ€"></div><button class="form-submit-btn" onclick="addCh()">ë“±ë¡</button></div>`:'')); renCh(); }
      window.addCh = () => { window.appData.channel.unshift({date:document.getElementById('ch-d').value, v1:document.getElementById('ch-v1').value, v2:document.getElementById('ch-v2').value}); saveAllData(); renCh(); }
      window.renCh = () => { document.getElementById('ch-tb').innerHTML = window.appData.channel.map((c,i)=>`<tr><td>${c.date}</td><td>${c.v1}</td><td>${c.v2}</td><td>${window.isAdmin?`<button class="action-btn btn-del" onclick="deleteRecord('channel',${i})">Ã—</button>`:'-'}</td></tr>`).join('')||'<tr><td colspan="4">ì—†ìŒ</td></tr>'; }

      window.openEntryTimeHistory = () => { showContent('â° ì…ì¥ ì‹œê°„', `<div class="table-wrapper">${genTable('en-tb',['ë‚ ì§œ','ì•Œë²„í”„','ì˜ë©”','ì…ì¥','ê´€ë¦¬'])}</div>` + (window.isAdmin?`<div class="form-group"><div class="form-row"><input type="date" id="en-d" class="form-control" value="${getTodayStr()}"><input type="text" id="en-a" class="form-control" placeholder="ì•Œ"><input type="text" id="en-y" class="form-control" placeholder="ì˜"><input type="text" id="en-t" class="form-control" placeholder="ì…"></div><button class="form-submit-btn" onclick="addEn()">ë“±ë¡</button></div>`:'')); renEn(); }
      window.addEn = () => { window.appData.entry.unshift({date:document.getElementById('en-d').value, al:document.getElementById('en-a').value, ym:document.getElementById('en-y').value, time:document.getElementById('en-t').value}); saveAllData(); renEn(); }
      window.renEn = () => { document.getElementById('en-tb').innerHTML = window.appData.entry.map((e,i)=>`<tr><td>${e.date}</td><td>${e.al}</td><td>${e.ym}</td><td>${e.time}</td><td>${window.isAdmin?`<button class="action-btn btn-del" onclick="deleteRecord('entry',${i})">Ã—</button>`:'-'}</td></tr>`).join('')||'<tr><td colspan="5">ì—†ìŒ</td></tr>'; }

      window.openGuestHistory = () => { showContent('ğŸ« ì†ë‹˜ ì •ë³´', `<div class="table-wrapper">${genTable('gu-tb',['ë‚ ì§œ','ë‹‰ë„¤ì„','ì†Œê°œ','í’ˆëª©','ê¸ˆì•¡','ë²„í”„','ê´€ë¦¬'])}</div>` + (window.isAdmin?`<div class="form-group"><div class="form-row"><input type="date" id="gu-d" class="form-control" value="${getTodayStr()}"><input type="text" id="gu-n" class="form-control" placeholder="ë‹‰ë„¤ì„"><input type="text" id="gu-i" class="form-control" placeholder="ì†Œê°œ"></div><div class="form-row"><input type="text" id="gu-it" class="form-control" placeholder="í’ˆëª©"><input type="number" id="gu-a" class="form-control" placeholder="ê¸ˆì•¡"><select id="gu-b" class="form-control"><option>ë°˜ë‚©</option><option>ë¯¸ë°˜ë‚©</option></select></div><button class="form-submit-btn" onclick="addGu()">ë“±ë¡</button></div>`:'')); renGu(); }
      window.addGu = () => { window.appData.guest.unshift({date:document.getElementById('gu-d').value, nick:document.getElementById('gu-n').value, intro:document.getElementById('gu-i').value, item:document.getElementById('gu-it').value, amt:document.getElementById('gu-a').value, buff:document.getElementById('gu-b').value}); saveAllData(); renGu(); }
      window.renGu = () => { document.getElementById('gu-tb').innerHTML = window.appData.guest.map((g,i)=>`<tr><td>${g.date}</td><td>${g.nick}</td><td>${g.intro}</td><td>${g.item}</td><td>${parseInt(g.amt||0).toLocaleString()}</td><td>${g.buff}</td><td>${window.isAdmin?`<button class="action-btn btn-del" onclick="deleteRecord('guest',${i})">Ã—</button>`:'-'}</td></tr>`).join('')||'<tr><td colspan="7">ì—†ìŒ</td></tr>'; }

      window.openLootHistory = () => { showContent('ğŸ’ ì „ë¦¬í’ˆ', `<div class="table-wrapper">${genTable('lo-tb',['ë‚ ì§œ','ë§ˆë¶','ì¥ë¹„','íŠ¹ì´ì‚¬í•­','ê´€ë¦¬'])}</div>` + (window.isAdmin?`<div class="form-group"><input type="date" id="lo-d" class="form-control" value="${getTodayStr()}"><input type="text" id="lo-m" class="form-control" placeholder="ë§ˆë¶"><input type="text" id="lo-e" class="form-control" placeholder="ì¥ë¹„"><input type="text" id="lo-n" class="form-control" placeholder="íŠ¹ì´ì‚¬í•­"><button class="form-submit-btn" onclick="addLo()">ë“±ë¡</button></div>`:'')); renLo(); }
      window.addLo = () => { window.appData.loot.unshift({date:document.getElementById('lo-d').value, mastery:document.getElementById('lo-m').value, equip:document.getElementById('lo-e').value, note:document.getElementById('lo-n').value}); saveAllData(); renLo(); }
      window.renLo = () => { document.getElementById('lo-tb').innerHTML = window.appData.loot.map((l,i)=>`<tr><td>${l.date}</td><td>${l.mastery}</td><td>${l.equip}</td><td>${l.note}</td><td>${window.isAdmin?`<button class="action-btn btn-del" onclick="deleteRecord('loot',${i})">Ã—</button>`:'-'}</td></tr>`).join('')||'<tr><td colspan="5">ì—†ìŒ</td></tr>'; }

      /* [ì—°ì°¨ & ê¸°íƒ€] */
      window.openLeaveCalendar = function() {
        const now = new Date(); const y = now.getFullYear(); const m = now.getMonth(); const fd = new Date(y, m, 1).getDay(); const ld = new Date(y, m + 1, 0).getDate();
        let h = `<div style="text-align:center;font-weight:bold;margin-bottom:10px;">${y}ë…„ ${m+1}ì›”</div><div class="calendar-container"><div class="calendar-grid">`;
        ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d=>h+=`<div class="calendar-header">${d}</div>`);
        for(let i=0; i<fd; i++) h += `<div class="calendar-day"></div>`;
        for(let d=1; d<=ld; d++) {
          const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const b = window.appData.leaves.filter(l=>l.date===ds).map(l=>`<span class="leave-badge ${l.role==='admin'?'admin':''}" onclick="delLeave(event,'${ds}','${l.nick}')">${l.nick}Ã—</span>`).join('');
          h += `<div class="calendar-day" onclick="addLeave('${ds}')"><span class="day-num">${d}</span>${b}</div>`;
        }
        showContent('ğŸ“… ì—°ì°¨ ì‹ ì²­', h+'</div></div>');
      }
      window.addLeave = (d) => { const n=prompt(`${d} ì—°ì°¨ ì‹ ì²­ì ì´ë¦„:`, window.currentUser); if(n){ window.appData.leaves.push({date:d, nick:n, role:window.userRole}); saveAllData(); openLeaveCalendar(); } }
      window.delLeave = (e,d,n) => { e.stopPropagation(); if(confirm('ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ const i=window.appData.leaves.findIndex(l=>l.date===d&&l.nick===n); if(i>-1){ window.appData.leaves.splice(i,1); saveAllData(); openLeaveCalendar(); } } }

      window.openMultiTimer = () => showContent('â±ï¸ íƒ€ì´ë¨¸', '<div style="text-align:center; padding:20px;">íƒ€ì´ë¨¸ ê¸°ëŠ¥ (ì¶”í›„ êµ¬í˜„)</div>');
      window.openGuestReviews = () => {
          const h = `<div style="background:#fff;padding:10px;border-radius:8px;margin-bottom:10px;"><div id="re-edit" class="review-editor" contenteditable="true" style="border:1px solid #ddd;min-height:80px;border-radius:4px;padding:5px;"></div><button class="form-submit-btn" onclick="saveRev()">ë“±ë¡</button></div><div id="re-list"></div>`;
          showContent('â­ ë¦¬ë·°', h); renRev();
      }
      window.saveRev = () => { window.appData.reviews.unshift({writer:window.currentUser, content:document.getElementById('re-edit').innerHTML, date:new Date().toLocaleString()}); saveAllData(); renRev(); }
      window.renRev = () => { document.getElementById('re-list').innerHTML = window.appData.reviews.map(r=>`<div style="background:#fff;padding:10px;border-bottom:1px solid #eee;"><b>${r.writer}</b> <span style="font-size:11px;color:#999;">${r.date}</span><br>${r.content}</div>`).join(''); }

      /* [íŒŒí‹° ê´€ë¦¬] */
      window.loadMembers = function() {
        const c=document.getElementById('member-list-container'); if(window.localMembers.length===0) return c.innerHTML='<div style="text-align:center;padding:20px;color:#999">íŒŒí‹°ì› ì—†ìŒ</div>';
        const grp={'1íŒŒí‹°':[],'2íŒŒí‹°':[],'3íŒŒí‹°':[],'ëŒ€ê¸°':[]};
        window.localMembers.forEach(m=>{ const j=getJobKey(m[1]); if(grp[m[3]])grp[m[3]].push({...{nick:m[0],job:m[1],lvl:m[2]}, cls:j}); });
        let h=''; Object.keys(grp).forEach(p=>{ if(grp[p].length){ h+=`<div class="party-header">${p}</div>`; grp[p].forEach(m=>{ h+=`<div class="member-item ${m.cls}"><div class="member-info"><span class="member-name">${m.nick}</span><span class="member-detail">${m.job}</span></div><div class="member-right"><span class="member-lv">Lv.${m.lvl}</span>${window.isAdmin?`<button class="delete-btn" onclick="delMem('${m.nick}')">Ã—</button>`:''}</div></div>`; }); } });
        c.innerHTML=h;
      }
      window.getJobKey = (j) => { if(j==='íˆì–´ë¡œ')return 'hero'; if(['ë‚˜ì´íŠ¸ë¡œë“œ','ì„€ë„ì–´'].some(k=>j.includes(k)))return 'thief'; if(['ë¹„ìˆ','ì•„í¬ë©”ì´ì§€'].some(k=>j.includes(k)))return 'mage'; if(['ë³´ìš°ë§ˆìŠ¤í„°','ì‹ ê¶'].some(k=>j.includes(k)))return 'archer'; if(j==='ë‹¤í¬ë‚˜ì´íŠ¸')return 'dk'; return ''; }
      window.delMem = (n) => { if(confirm('ì‚­ì œ?')){ window.localMembers=window.localMembers.filter(m=>m[0]!==n); saveAllData(); loadMembers(); } }
      window.resetParty = () => { if(confirm('ì´ˆê¸°í™”?')){ window.localMembers=[]; saveAllData(); loadMembers(); } }
      window.openAddMemberModal = () => { document.getElementById('add-member-modal').style.display='flex'; switchAddTab('pick'); renderEasySetup(); }
      window.closeAddModal = (e) => { if(e.target.id==='add-member-modal') e.target.style.display='none'; }
      window.switchAddTab = (t) => { document.getElementById('tab-btn-pick').className=t==='pick'?'tab-btn active':'tab-btn'; document.getElementById('tab-btn-single').className=t==='single'?'tab-btn active':'tab-btn'; document.getElementById('tab-content-pick').style.display=t==='pick'?'block':'none'; document.getElementById('tab-content-single').style.display=t==='single'?'block':'none'; }
      window.renderEasySetup = () => {
        const pool=document.getElementById('pool-container'); 
        const av=window.allMembers.filter(m=>!window.localMembers.some(l=>l[0]===m.nick));
        pool.innerHTML=av.map(m=>`<div class="pool-chip ${getJobKey(m.job)} ${window.selectedNicks.includes(m.nick)?'selected':''}" onclick="togPool('${m.nick}')"><div class="chip-del-btn" onclick="delPool(event,'${m.nick}')">Ã—</div><span class="chip-name">${m.nick}</span><span class="chip-sub">${m.job}</span></div>`).join('');
      }
      window.togPool = (n) => { const i=window.selectedNicks.indexOf(n); if(i>-1)window.selectedNicks.splice(i,1); else window.selectedNicks.push(n); renderEasySetup(); }
      window.delPool = (e,n) => { e.stopPropagation(); if(confirm('ì˜êµ¬ì‚­ì œ?')){ window.allMembers=window.allMembers.filter(m=>m.nick!==n); saveAllData(); renderEasySetup(); } }
      window.addSelectedToParty = (p) => { window.selectedNicks.forEach(n=>{ const m=window.allMembers.find(x=>x.nick===n); if(m)window.localMembers.push([m.nick,m.job,m.level,p]); }); window.selectedNicks=[]; saveAllData(); loadMembers(); renderEasySetup(); }
      window.submitNewMember = () => { window.allMembers.push({nick:document.getElementById('new-nick').value, job:document.getElementById('new-job').value, level:document.getElementById('new-level').value}); saveAllData(); renderEasySetup(); }

      /* [ê³µí†µ] */
      window.tryLogin = () => { const n=document.getElementById('login-nick').value, p=document.getElementById('login-pw').value; if(n==='ê´€ë¦¬ì'&&p===window.sysConfig.pwAdmin)authS(n,'admin'); else if(p===window.sysConfig.pwMember)authS(n,'member'); else if(p===window.sysConfig.pwGuest)authS(n,'guest'); else alert('ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜'); }
      function authS(n,r) { window.currentUser=n; window.userRole=r; window.isAdmin=(r==='admin'); document.getElementById('login-view').style.display='none'; document.getElementById('main-app').style.display='block'; document.getElementById('user-display').innerText=n; const b=document.getElementById('role-badge'); b.innerText=(r==='admin'?'ê´€ë¦¬ì':r==='member'?'ê³µëŒ€ì›':'ì†ë‹˜'); b.style.background=(r==='admin'?'#ff4d4f':r==='member'?'#1890ff':'#52c41a'); if(window.isAdmin){ document.getElementById('add-member-btn').style.display='block'; document.getElementById('reset-party-btn').style.display='block'; } refreshUI(); }
      window.getTodayStr = () => new Date().toISOString().split('T')[0];
      window.genTable = (id,ths) => `<table class="record-table"><thead><tr>${ths.map(t=>`<th>${t}</th>`).join('')}</tr></thead><tbody id="${id}"></tbody></table>`;
      window.showContent = (t,h) => { document.getElementById('modal-title').innerText=t; document.getElementById('modal-content').innerHTML=h; document.getElementById('modal-overlay').style.display='flex'; }
      window.closeModal = (e) => { if(e.target.classList.contains('modal-overlay'))e.target.style.display='none'; }
      window.deleteRecord = (t,i) => { if(confirm('ì‚­ì œ?')){ window.appData[t].splice(i,1); saveAllData(); refreshUI(); } }
      window.handleEnter = (e) => { if(e.keyCode===13)tryLogin(); }
    </script>
  </body>
</html>
