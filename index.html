<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í˜¼í…Œì¼ ê³µëŒ€ ê´€ë¦¬ í”Œë«í¼ (Advanced)</title>
    
    <style>
      /* --- [ê¸°ë³¸ ì„¤ì •] --- */
      body {
        font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
        margin: 0; padding: 0; color: #333; height: 100vh;
        overflow-x: hidden; 
        background-color: #f0f2f5; 
      }
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

      /* --- [ë¡œë¹„ (ê³µëŒ€ ì„ íƒ)] --- */
      #lobby-view {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #f0f2f5; z-index: 10000;
        display: flex; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box;
        overflow-y: auto;
      }
      .lobby-header { text-align: center; margin-top: 40px; margin-bottom: 30px; }
      .lobby-title { font-size: 28px; font-weight: 800; color: #2c3e50; letter-spacing: -1px; margin-bottom: 5px; }
      .lobby-sub { font-size: 14px; color: #7f8c8d; }
      
      .channel-list { 
        display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; 
        width: 100%; max-width: 900px; 
      }
      .channel-card {
        background: #fff; border-radius: 16px; padding: 20px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee;
        transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;
        display: flex; flex-direction: column; justify-content: space-between;
        min-height: 120px;
      }
      .channel-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); border-color: #ff6b00; }
      .ch-name { font-size: 18px; font-weight: 800; color: #333; margin-bottom: 5px; }
      .ch-info { font-size: 12px; color: #999; }
      .ch-lock { margin-top: 15px; display: flex; justify-content: flex-end; align-items: center; font-size: 12px; color: #ff6b00; font-weight: bold; }
      
      .create-card {
        background: #fdfdfd; border: 2px dashed #ddd; display: flex; align-items: center; justify-content: center;
        color: #999; font-weight: bold; flex-direction: column; gap: 8px;
      }
      .create-card:hover { border-color: #ff6b00; color: #ff6b00; background: #fffcf9; }

      /* --- [ë¡œê·¸ì¸] --- */
      #login-view {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #f0f2f5; z-index: 9999; display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
      }
      .login-card {
        background: #ffffff; padding: 40px 30px; border-radius: 20px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 360px; text-align: center; border: 1px solid #e1e4e8;
      }
      .login-title { color: #ff6b00; font-size: 26px; font-weight: 800; margin-bottom: 30px; letter-spacing: -0.5px; }
      .login-input {
        width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 10px;
        font-size: 15px; outline: none; background: #f9f9f9; transition: all 0.2s; box-sizing: border-box;
      }
      .login-input:focus { border-color: #ff6b00; background: #fff; }
      .login-btn {
        width: 100%; background-color: #ff6b00; color: white; border: none; padding: 16px; border-radius: 10px;
        font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: background 0.2s;
      }
      .login-btn:hover { background-color: #e65c00; }
      .back-to-lobby { margin-top: 15px; color: #999; font-size: 13px; text-decoration: underline; cursor: pointer; }

      /* --- [ë©”ì¸ ë ˆì´ì•„ì›ƒ] --- */
      #main-app { display: none; max-width: 1200px; margin: 0 auto; padding: 20px; box-sizing: border-box; min-height: 100%; padding-bottom: 50px; }
      .header-area {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px 20px;
        background: #ffffff; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #eaeaea;
      }
      .header-title h1 { margin: 0; font-size: 22px; color: #2c3e50; font-weight: 800; letter-spacing: -0.5px; }
      .header-title .subtitle { color: #fff; font-size: 13px; font-weight: bold; background: #ff6b00; padding: 4px 10px; border-radius: 20px; margin-left: 10px; vertical-align: middle; }
      .user-info { font-weight: 600; color: #555; display: flex; align-items: center; gap: 12px; font-size: 14px; }
      .logout-link { font-size: 12px; color: #999; text-decoration: underline; cursor: pointer; }

      .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
      @media (min-width: 900px) { .dashboard-grid { grid-template-columns: 320px 1fr; } }
      @media (max-width: 600px) {
        #main-app { padding: 10px; padding-bottom: 60px; }
        .header-area { flex-direction: column; align-items: flex-start; gap: 10px; padding: 15px; }
        .user-info { width: 100%; justify-content: space-between; border-top: 1px solid #eee; padding-top: 10px; margin-top: 5px; }
        .right-panel { grid-template-columns: repeat(2, 1fr); gap: 10px; } 
        .modal-card { width: 95%; max-height: 90vh; padding: 15px; }
        .party-row { flex-direction: column; align-items: stretch; gap: 10px; text-align: center; }
        .form-row { flex-wrap: wrap; }
        .form-control { width: 100%; }
      }

      /* --- [ì¹´ë“œ ê³µí†µ] --- */
      .tilt-card {
        background: #ffffff; border: 1px solid #eaeaea; border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.03); overflow: hidden; transition: transform 0.1s ease-out, box-shadow 0.2s;
        perspective: 1000px; transform-style: preserve-3d; position: relative;
      }
      .tilt-card:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.06); }

      /* ì¢Œì¸¡ íŒ¨ë„ */
      .left-panel { display: flex; flex-direction: column; height: 100%; min-height: 500px; }
      .panel-header { padding: 18px 20px; border-bottom: 1px solid #f0f0f0; background: #fff; display: flex; justify-content: space-between; align-items: center; }
      .panel-title { font-size: 17px; font-weight: 800; color: #333; }
      .header-btns { display: flex; gap: 8px; }
      .icon-btn { background: #f5f5f5; border: none; cursor: pointer; font-size: 14px; color: #666; width: 34px; height: 34px; border-radius: 10px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
      .icon-btn:hover { background: #ff6b00; color: white; transform: translateY(-2px); }
      #add-member-btn, #reset-party-btn { display: none; }
      .member-list-container { flex: 1; overflow-y: auto; padding: 15px; background: #fafafa; }

      /* íŒŒí‹° ëª©ë¡ ë””ìì¸ */
      .party-header { 
        background: #333; color: #fff; font-weight: 800; font-size: 12px; 
        padding: 6px 12px; margin-top: 20px; margin-bottom: 10px; border-radius: 6px; 
        display: inline-block; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .party-header:first-child { margin-top: 0; }
      
      .member-item { 
        display: flex; justify-content: space-between; align-items: center; 
        padding: 12px 14px; margin-bottom: 8px; background: #ffffff; border-radius: 12px; 
        border: 1px solid #eee; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        position: relative; overflow: hidden;
      }
      .member-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #ddd; }
      .member-item.hero::before { background: #ff4d4f; }
      .member-item.thief::before { background: #52c41a; }
      .member-item.mage::before { background: #1890ff; }
      .member-item.archer::before { background: #faad14; }
      .member-item.dk::before { background: #722ed1; }

      .member-item:hover { transform: translateX(3px); border-color: #ff6b00; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
      .member-info { display: flex; flex-direction: column; }
      .member-name { font-weight: 800; color: #222; font-size: 15px; }
      .member-detail { font-size: 12px; color: #888; margin-top: 2px; font-weight: 500; }
      .member-right { display: flex; align-items: center; gap: 8px; }
      .member-lv { background: #f0f2f5; color: #555; padding: 4px 8px; border-radius: 8px; font-size: 11px; font-weight: 700; border: 1px solid #e1e4e8; }
      .delete-btn { 
        background: #fff1f0; color: #ff4d4f; border: 1px solid #ffa39e; border-radius: 8px; 
        width: 26px; height: 26px; font-size: 14px; font-weight: bold; cursor: pointer; 
        display: flex; align-items: center; justify-content: center; transition: all 0.2s;
      }
      .delete-btn:hover { background: #ff4d4f; color: #fff; }

      /* ìš°ì¸¡ íŒ¨ë„ ë©”ë‰´ */
      .right-panel { display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(4, 1fr); gap: 15px; height: 100%; }
      .menu-btn { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; cursor: pointer; padding: 20px; background: #ffffff; }
      .menu-icon { font-size: 36px; margin-bottom: 12px; display: block; }
      .menu-label { font-size: 16px; font-weight: 700; color: #333; }
      .menu-sub { font-size: 12px; color: #999; margin-top: 6px; font-weight: 500; }
      .highlight-text { color: #ff6b00 !important; }

      /* --- [ëª¨ë‹¬ ê³µí†µ] --- */
      .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
      .modal-card { background: #ffffff; width: 98%; max-width: 1000px; border-radius: 20px; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); animation: slideUp 0.25s ease-out; position: relative; }
      @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
      .modal-title { font-size: 20px; font-weight: 800; color: #333; }
      .close-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: #ccc; }
      .modal-body { max-height: 80vh; overflow-y: auto; font-size: 14px; line-height: 1.6; }

      .form-group { margin-bottom: 12px; }
      .form-label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: #555; }
      .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 13px; box-sizing: border-box; background: #fff; }
      .form-control:focus { border-color: #ff6b00; outline: none; }
      .form-control[readonly] { background-color: #f9f9f9; color: #666; font-weight: bold; }
      .form-row { display: flex; gap: 8px; align-items: center; }
      .form-submit-btn { width: 100%; background: #ff6b00; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 14px; }
      .form-submit-btn:hover { background: #e65c00; }
      .btn-outline { background: #fff; border: 1px solid #ddd; color: #555; }
      .btn-outline:hover { background: #f5f5f5; }

      /* í…Œì´ë¸” ëª¨ë°”ì¼ ëŒ€ì‘ (ìŠ¤í¬ë¡¤) */
      .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 10px; border: 1px solid #eee; border-radius: 8px; }
      .record-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 0; min-width: 500px; }
      .record-table th { background: #f8f9fa; padding: 10px 8px; text-align: center; border-bottom: 1px solid #ddd; font-weight: 600; color: #555; white-space: nowrap;}
      .record-table td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: center; color: #333; vertical-align: middle; }
      .record-empty { text-align: center; padding: 20px; color: #aaa; font-style: italic; }
      .action-btn { border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px; margin: 0 1px; font-weight: bold; }
      .btn-del { background: #fff1f0; color: #f5222d; }
      .btn-pay { background: #e6f7ff; color: #1890ff; }
      .btn-info { background: #e6fffb; color: #006d75; }

      /* --- [êµ¬ê¸€ ìº˜ë¦°ë” ìŠ¤íƒ€ì¼] --- */
      .calendar-container { background: #fff; border-radius: 12px; border: 1px solid #e0e0e0; overflow: hidden; }
      .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: #e0e0e0; gap: 1px; }
      .calendar-header { background: #f8f9fa; padding: 10px; font-weight: bold; text-align: center; font-size: 13px; color: #70757a; }
      .calendar-day { background: #fff; min-height: 80px; padding: 4px; cursor: pointer; transition: background 0.2s; position: relative; }
      .calendar-day:hover { background: #f1f3f4; }
      .day-num { font-size: 12px; font-weight: 600; margin-bottom: 4px; display: block; color: #3c4043; text-align: center; }
      .leave-badge { background: #1a73e8; color: white; font-size: 10px; padding: 2px 4px; border-radius: 4px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; font-weight: 500; cursor: pointer; }
      .leave-badge:hover { opacity: 0.8; }
      .leave-badge.admin { background: #d93025; }
      .today-cell { background: #f8f9ff !important; }
      .today-cell .day-num { background: #1a73e8; color: white; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; }

      /* ëŒ€ê¸°ì‹¤/íŒŒí‹° í¸ì„± ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
      .pool-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; background: #f8f9fa; padding: 15px; border-radius: 16px; border: 1px solid #eee; margin-bottom: 20px; max-height: 300px; overflow-y: auto; }
      .pool-chip { 
        position: relative; padding: 10px 4px; border-radius: 12px; border: 2px solid transparent; 
        background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; 
        justify-content: center; gap: 4px; min-height: 80px; transition: all 0.2s; box-shadow: 0 4px 8px rgba(0,0,0,0.03); 
      }
      .pool-chip:hover { transform: translateY(-3px); }
      .pool-chip.selected { border-color: #ff6b00; background: #fffcf5; transform: scale(0.96); box-shadow: inset 0 0 10px rgba(255,107,0,0.05); }
      .pool-chip .chip-name { font-weight: 800; font-size: 13px; color: #222; text-align: center; word-break: keep-all; }
      .pool-chip .chip-sub { font-size: 11px; font-weight: 600; color: #777; }
      
      .pool-chip.bg-hero { border-bottom: 4px solid #ff4d4f; }
      .pool-chip.bg-thief { border-bottom: 4px solid #52c41a; }
      .pool-chip.bg-archer { border-bottom: 4px solid #faad14; }
      .pool-chip.bg-dk { border-bottom: 4px solid #722ed1; }
      .pool-chip.bg-mage { border-bottom: 4px solid #1890ff; }

      .party-row { 
        background: #fdfdfd; border: 1px solid #eee; border-radius: 12px; padding: 12px 20px; 
        margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;
        transition: all 0.2s;
      }
      .party-row:hover { background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
      .party-label { font-weight: 800; font-size: 17px; color: #333; }
      
      .party-add-btn { 
        background: #f0f0f0; color: #999; border: none; padding: 10px 20px; border-radius: 10px; 
        font-weight: 800; cursor: not-allowed; transition: all 0.2s; font-size: 14px;
      }
      .party-add-btn.active { 
        background: #333; color: white; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
      }
      .party-add-btn.active:hover { transform: translateY(-2px); background: #ff6b00; }
      .party-add-btn.active:active { transform: translateY(0); }

      /* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      .tab-container { 
        display: flex; background: #f1f3f5; border-radius: 12px; padding: 4px; margin-bottom: 20px; border: none; 
      }
      .tab-btn { 
        flex: 1; padding: 10px; border: none; border-radius: 8px; 
        font-weight: 700; color: #888; cursor: pointer; font-size: 14px; 
        transition: all 0.2s; background: transparent; 
      }
      .tab-btn.active { 
        background: #fff; color: #ff6b00; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
      }

      /* --- [NEW: ê³ ê¸‰ ë¶„ë°°ê¸ˆ ê´€ë¦¬ ìŠ¤íƒ€ì¼] --- */
      .raid-card { border: 1px solid #ddd; border-radius: 12px; padding: 15px; margin-bottom: 15px; background: #fff; }
      .raid-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
      .raid-title { font-weight: 800; font-size: 16px; color: #333; }
      .raid-status { font-size: 12px; font-weight: bold; padding: 4px 8px; border-radius: 6px; }
      .status-open { background: #e6fffb; color: #006d75; }
      .status-closed { background: #f5f5f5; color: #999; }
      
      .raid-stat-box { display: flex; gap: 10px; background: #fafafa; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; }
      .stat-item { flex: 1; text-align: center; }
      .stat-val { font-weight: 800; color: #ff6b00; font-size: 15px; }
      
      .item-add-box { background: #fffcf5; border: 1px dashed #ff6b00; padding: 15px; border-radius: 10px; margin-top: 15px; }
      .toggle-option { display: flex; align-items: center; gap: 10px; margin-top: 8px; padding: 8px; background: #fff; border: 1px solid #eee; border-radius: 6px; }
      
      .calc-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }
      .calc-row.final { border-top: 1px solid #ddd; padding-top: 6px; font-weight: bold; font-size: 15px; margin-top: 6px; color: #ff6b00; }
      .minus-val { color: #ff4d4f; }
      .plus-val { color: #52c41a; }
      
      .share-control { display: flex; align-items: center; gap: 5px; }
      .share-select { padding: 4px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px; width: 130px; }
      .share-input { padding: 4px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px; width: 60px; text-align: center; }

      /* íšŒì°¨ ìƒì„± ë©¤ë²„ ì„ íƒ ì¹© */
      .select-member-pool { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 8px; }
      .select-chip { font-size: 12px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 15px; cursor: pointer; user-select: none; background: #fff; transition: all 0.2s; }
      .select-chip.selected { background: #ff6b00; color: white; border-color: #ff6b00; font-weight: bold; }

      /* ì§€ê¸‰ ì²˜ë¦¬ íŒ¨ë„ */
      .payout-panel { background: #fdfdfd; border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-top: 20px; }
      .payout-title { font-weight: 800; color: #333; margin-bottom: 10px; border-left: 4px solid #1890ff; padding-left: 10px; font-size: 14px; }

      /* --- [í† ìŠ¤íŠ¸] --- */
      #save-toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 14px; opacity: 0; transition: opacity 0.5s; z-index: 10000; pointer-events: none; }
      #save-toast.show { opacity: 1; }
    </style>
  </head>
  <body>

    <!-- [0] ë¡œë¹„ (ì±„ë„ ì„ íƒ) -->
    <div id="lobby-view">
      <div class="lobby-header">
        <div class="lobby-title">ë©”ì´í”ŒìŠ¤í† ë¦¬ ê³µëŒ€ ê´€ë¦¬</div>
        <div class="lobby-sub">í•¨ê»˜í•˜ëŠ” ì¦ê±°ì›€, íˆ¬ëª…í•œ ì •ì‚°</div>
      </div>
      
      <div id="channel-list" class="channel-list">
        <!-- ì±„ë„ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
      </div>
      
      <div class="channel-card create-card" onclick="openCreateModal()">
        <span style="font-size:30px;">+</span>
        <span>ìƒˆë¡œìš´ ê³µëŒ€ ë§Œë“¤ê¸°</span>
      </div>
    </div>

    <!-- [1] ë¡œê·¸ì¸ -->
    <div id="login-view">
      <div class="login-card tilt-card" data-tilt>
        <div class="login-title" id="login-channel-name">ê³µëŒ€ ë¡œê·¸ì¸</div>
        <input type="text" id="login-nick" class="login-input" placeholder="ìºë¦­í„°ëª… (ê´€ë¦¬ìëŠ” 'ê´€ë¦¬ì')">
        <input type="password" id="login-pw" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="handleEnter(event)">
        <button class="login-btn" onclick="tryLogin()">ì ‘ì†í•˜ê¸°</button>
        <div class="back-to-lobby" onclick="location.reload()">â† ë‹¤ë¥¸ ê³µëŒ€ ì„ íƒí•˜ê¸°</div>
      </div>
    </div>

    <!-- [2] ë©”ì¸ ì•± (ê¸°ì¡´ê³¼ ë™ì¼) -->
    <div id="main-app">
      <div class="header-area">
        <div class="header-title">
          <h1><span id="app-guild-name">ì‹œëŒ€ ê¸¸ë“œ</span> <span class="subtitle">ê³µëŒ€ ê´€ë¦¬ ì‹œìŠ¤í…œ</span></h1>
        </div>
        <div class="user-info">
          <span id="role-badge" style="font-size:11px; padding:2px 6px; border-radius:4px; margin-right:5px; color:white; font-weight:bold;"></span>
          <span id="user-display"></span>ë‹˜
          <span class="logout-link" onclick="location.reload()">(ë¡œê·¸ì•„ì›ƒ)</span>
        </div>
      </div>

      <div class="dashboard-grid">
        <!-- ì¢Œì¸¡: ëŒ€ì› ëª…ë‹¨ -->
        <div class="left-panel tilt-card" data-tilt>
          <div class="panel-header">
            <span class="panel-title">ğŸ›¡ï¸ ì˜¤ëŠ˜ì˜ íŒŒí‹° ëª…ë‹¨</span>
            <div class="header-btns">
              <button id="add-member-btn" class="icon-btn" onclick="openAddMemberModal()" title="íŒŒí‹° í¸ì„±">â•</button>
              <button id="reset-party-btn" class="icon-btn" onclick="resetParty()" title="íŒŒí‹° ì´ˆê¸°í™”">ğŸ—‘ï¸</button>
              <button class="icon-btn" onclick="loadMembers()" title="ìƒˆë¡œê³ ì¹¨">â†»</button>
            </div>
          </div>
          <div id="member-list-container" class="member-list-container">
            <div style="text-align:center; padding:20px; color:#999;">ë¡œë”© ì¤‘...</div>
          </div>
        </div>

        <!-- ìš°ì¸¡: ë©”ë‰´ -->
        <div class="right-panel">
          <div class="menu-btn tilt-card" data-tilt onclick="openChannelHistory()">
            <span class="menu-icon">ğŸ“¢</span><span class="menu-label">ì˜¤ëŠ˜ì˜ ì±„ë„</span><span class="menu-sub">ë¦¬í”„ë ˆ / ì›ì •ëŒ€</span>
          </div>
          <div class="menu-btn tilt-card" data-tilt onclick="openEntryTimeHistory()">
            <span class="menu-icon">â°</span><span class="menu-label">ì…ì¥ ì‹œê°„</span><span class="menu-sub">ì•Œë²„í”„ / ì˜ë©”</span>
          </div>
          <div class="menu-btn tilt-card" data-tilt onclick="openGuestHistory()">
            <span class="menu-icon">ğŸ«</span><span class="menu-label">ì†ë‹˜ ì •ë³´</span><span class="menu-sub">ì˜ˆì•½ ë° êµ¬ë§¤</span>
          </div>
          <div class="menu-btn tilt-card" data-tilt onclick="openMultiTimer()">
            <span class="menu-icon">â±ï¸</span><span class="menu-label">ë ˆì´ë“œ íƒ€ì´ë¨¸</span><span class="menu-sub">ë¦¬ì €/ê³µë¬´/í•´ì œ</span>
          </div>
          <div class="menu-btn tilt-card" data-tilt onclick="openLeaveCalendar()">
            <span class="menu-icon">ğŸ“…</span><span class="menu-label">ì—°ì°¨ ì‹ ì²­</span><span class="menu-sub">êµ¬ê¸€ ìº˜ë¦°ë” ìŠ¤íƒ€ì¼</span>
          </div>
          <div class="menu-btn tilt-card" data-tilt onclick="openLootHistory()">
            <span class="menu-icon">ğŸ’</span><span class="menu-label">ì „ë¦¬í’ˆ ì •ë³´</span><span class="menu-sub">ë§ˆìŠ¤í„°ë¦¬ë¶ / ì¥ë¹„</span>
          </div>
          <div class="menu-btn tilt-card" data-tilt onclick="openAdvancedDistribution()">
            <span class="menu-icon">ğŸ’¸</span><span class="menu-label highlight-text">ë¶„ë°°ê¸ˆ ì •ë³´</span><span class="menu-sub">ì†Œê°œë¹„/ì¸ì„¼í‹°ë¸Œ/íŒ¨ë„í‹°</span>
          </div>
          <div class="menu-btn tilt-card" data-tilt onclick="openGuestReviews()">
            <span class="menu-icon">â­</span><span class="menu-label">ì†ë‹˜ ë¦¬ë·°</span><span class="menu-sub">í›„ê¸° ë° ì¸ì¦ìƒ·</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ëª¨ë‹¬: ê³µí†µ -->
    <div id="modal-overlay" class="modal-overlay" onclick="closeModal(event)">
      <div class="modal-card">
        <div class="modal-header">
          <span id="modal-title" class="modal-title">ì œëª©</span>
          <button class="close-btn" onclick="document.getElementById('modal-overlay').style.display='none'">&times;</button>
        </div>
        <div class="modal-body">
          <div id="modal-content"></div>
        </div>
      </div>
    </div>

    <!-- ëª¨ë‹¬: ê³µëŒ€ ìƒì„± ì „ìš© -->
    <div id="create-channel-modal" class="modal-overlay" onclick="if(event.target.id==='create-channel-modal') this.style.display='none'">
      <div class="modal-card" style="max-width:400px;">
        <div class="modal-header">
          <span class="modal-title">âœ¨ ìƒˆë¡œìš´ ê³µëŒ€ ìƒì„±</span>
          <button class="close-btn" onclick="document.getElementById('create-channel-modal').style.display='none'">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">ê³µëŒ€ ì´ë¦„</label>
            <input type="text" id="new-ch-name" class="form-control" placeholder="ì˜ˆ: ë¬´ì ê³µëŒ€">
          </div>
          <div class="form-group">
            <label class="form-label">ì±„ë„ ì ‘ì† ë¹„ë°€ë²ˆí˜¸</label>
            <input type="text" id="new-ch-pw" class="form-control" placeholder="ê³µëŒ€ì›ë“¤ì—ê²Œ ê³µìœ í•  ë¹„ë²ˆ">
          </div>
          <div class="form-group" style="margin-top:20px; border-top:1px dashed #ddd; padding-top:10px;">
            <label class="form-label" style="color:#ff6b00;">ğŸ” ë§ˆìŠ¤í„° í‚¤ (ìƒì„± ìŠ¹ì¸ìš©)</label>
            <input type="password" id="master-key-input" class="form-control" placeholder="ê´€ë¦¬ì ìŠ¹ì¸ ì•”í˜¸">
          </div>
          <button class="form-submit-btn" onclick="createNewChannel()">ê³µëŒ€ ìƒì„±í•˜ê¸°</button>
        </div>
      </div>
    </div>

    <!-- ëª¨ë‹¬: íŒŒí‹° í¸ì„± ì „ìš© -->
    <div id="add-member-modal" class="modal-overlay" onclick="closeAddModal(event)">
      <div class="modal-card" style="max-width:600px;">
        <div class="modal-header">
          <span class="modal-title">ğŸ› ï¸ íŒŒí‹° í¸ì„± ê´€ë¦¬ ì„¼í„°</span>
          <button class="close-btn" onclick="document.getElementById('add-member-modal').style.display='none'">&times;</button>
        </div>
        <div class="modal-body">
          <div class="tab-container">
            <button class="tab-btn active" id="tab-btn-pick" onclick="switchAddTab('pick')">ê°„í¸ í¸ì„±</button>
            <button class="tab-btn" id="tab-btn-single" onclick="switchAddTab('single')">ì‹ ê·œ ë“±ë¡</button>
          </div>
          <div id="tab-content-pick">
            <div style="font-size:13px; color:#666; margin-bottom:8px; font-weight:bold;">1ë‹¨ê³„: ëŒ€ê¸°ì‹¤ ë©¤ë²„ ì„ íƒ</div>
            <div id="pool-container" class="pool-container"></div>
            <div style="font-size:13px; color:#666; margin-bottom:12px; font-weight:bold; margin-top:20px;">2ë‹¨ê³„: ëª©í‘œ íŒŒí‹° ì§€ì •</div>
            <div class="party-row">
                <span class="party-label">1íŒŒí‹° (ì›ì •ëŒ€)</span>
                <button class="party-add-btn" id="btn-p1" onclick="addSelectedToParty('1íŒŒí‹°')">+ ì…ì¥ì‹œí‚¤ê¸°</button>
            </div>
            <div class="party-row">
                <span class="party-label">2íŒŒí‹°</span>
                <button class="party-add-btn" id="btn-p2" onclick="addSelectedToParty('2íŒŒí‹°')">+ ì…ì¥ì‹œí‚¤ê¸°</button>
            </div>
            <div class="party-row">
                <span class="party-label">3íŒŒí‹°</span>
                <button class="party-add-btn" id="btn-p3" onclick="addSelectedToParty('3íŒŒí‹°')">+ ì…ì¥ì‹œí‚¤ê¸°</button>
            </div>
            <div class="party-row">
                <span class="party-label">ëŒ€ê¸°ì ëª…ë‹¨</span>
                <button class="party-add-btn" id="btn-pw" onclick="addSelectedToParty('ëŒ€ê¸°')">+ ì…ì¥ì‹œí‚¤ê¸°</button>
            </div>
          </div>
          <div id="tab-content-single" style="display:none; padding:10px;">
            <div class="form-group">
                <label class="form-label">ìºë¦­í„° ë‹‰ë„¤ì„</label>
                <input type="text" id="new-nick" class="form-control" placeholder="ì¸ê²Œì„ ë‹‰ë„¤ì„">
            </div>
            <div class="form-group">
                <label class="form-label">ì§ì—… ì„ íƒ</label>
                <select id="new-job" class="form-control">
                    <option value="íˆì–´ë¡œ">íˆì–´ë¡œ</option><option value="ë‚˜ì´íŠ¸ë¡œë“œ">ë‚˜ì´íŠ¸ë¡œë“œ</option>
                    <option value="ë¹„ìˆ">ë¹„ìˆ</option><option value="ë³´ìš°ë§ˆìŠ¤í„°">ë³´ìš°ë§ˆìŠ¤í„°</option>
                    <option value="ë‹¤í¬ë‚˜ì´íŠ¸">ë‹¤í¬ë‚˜ì´íŠ¸</option><option value="ì„€ë„ì–´">ì„€ë„ì–´</option>
                    <option value="ì‹ ê¶">ì‹ ê¶</option><option value="ìº¡í‹´">ìº¡í‹´</option><option value="ë°”ì´í¼">ë°”ì´í¼</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">ë ˆë²¨</label>
                <input type="number" id="new-level" class="form-control" placeholder="120">
            </div>
            <button class="form-submit-btn" onclick="submitNewMember()">ëŒ€ê¸°ì‹¤(ëª…ë¶€)ì— ë“±ë¡</button>
          </div>
        </div>
      </div>
    </div>

    <div id="save-toast">â˜ï¸ ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ</div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, doc, setDoc, getDocs, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // =========================================================================
      // [Firebase ì„¤ì •]
      // =========================================================================
      const myFirebaseConfig = {
        apiKey: "AIzaSyAUdwSO5XwI6xODntL2aypZEUShW0kVThI",
        authDomain: "sidae-guild-horntail.firebaseapp.com",
        projectId: "sidae-guild-horntail",
        storageBucket: "sidae-guild-horntail.firebasestorage.app",
        messagingSenderId: "494207905469",
        appId: "1:494207905469:web:bfacf66949995eaa6391d4"
      };
      
      const MASTER_CREATION_KEY = "admin1234"; 
      const ROOT_APP_ID = "raid-platform-v1";
      // =========================================================================

      window.sysConfig = { pwAdmin: '9999', pwMember: '0000', pwGuest: '7777' };
      window.currentUser = "";
      window.userRole = "";
      window.isAdmin = false;
      window.currentChannelId = ""; 
      
      // ì•± ë°ì´í„° ì´ˆê¸°ê°’ (NEW: raidSessions ì¶”ê°€)
      const initialAppData = { 
        channel: [], entry: [], guest: [], loot: [], leaves: [], reviews: [],
        raidSessions: [] // íšŒì°¨ë³„ ì •ì‚° ë°ì´í„°
      };
      window.appData = JSON.parse(JSON.stringify(initialAppData));
      window.localMembers = [];
      window.allMembers = [];
      window.selectedNicks = [];
      
      // ë¡œì»¬ ë³€ìˆ˜
      window.currentRaidId = null;
      window.newRaidSelectedMembers = []; // íšŒì°¨ ìƒì„± ì‹œ ì„ íƒëœ ë©¤ë²„ë“¤

      let db, auth;

      (async function init() {
        const app = initializeApp(myFirebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        await signInAnonymously(auth);
        onAuthStateChanged(auth, (user) => { 
          if(user) {
            loadChannelList();
          }
        });
      })();

      // --- [ë¡œë¹„ & ì±„ë„ ë¡œì§] ---
      async function loadChannelList() {
        const listDiv = document.getElementById('channel-list');
        listDiv.innerHTML = '<div style="text-align:center; padding:20px;">ê³µëŒ€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        try {
          const querySnapshot = await getDocs(collection(db, 'artifacts', ROOT_APP_ID, 'public', 'data', 'raid_channels'));
          if(querySnapshot.empty) {
             listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">ìƒì„±ëœ ê³µëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²« ê³µëŒ€ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!</div>';
             return;
          }
          let html = '';
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            html += `
            <div class="channel-card" onclick="enterChannel('${doc.id}', '${data.password}', '${data.name}')">
              <div>
                <div class="ch-name">${data.name}</div>
                <div class="ch-info">ID: ${doc.id}</div>
              </div>
              <div class="ch-lock">ğŸ”’ ë¹„ê³µê°œ ì±„ë„</div>
            </div>`;
          });
          listDiv.innerHTML = html;
        } catch (e) {
          console.error(e);
          listDiv.innerHTML = 'ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨';
        }
      }

      window.openCreateModal = function() { document.getElementById('create-channel-modal').style.display = 'flex'; }
      window.createNewChannel = async function() {
        const name = document.getElementById('new-ch-name').value.trim();
        const pw = document.getElementById('new-ch-pw').value.trim();
        const key = document.getElementById('master-key-input').value.trim();
        if(!name || !pw) return alert('ê³µëŒ€ ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        if(key !== MASTER_CREATION_KEY) return alert('ë§ˆìŠ¤í„° í‚¤(ìŠ¹ì¸ ì•”í˜¸)ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        const newId = 'raid_' + Date.now();
        try {
          const docRef = doc(db, 'artifacts', ROOT_APP_ID, 'public', 'data', 'raid_channels', newId);
          await setDoc(docRef, { name: name, password: pw, records: JSON.stringify(initialAppData), pool: JSON.stringify([]), members: JSON.stringify([]) });
          alert(`[${name}] ê³µëŒ€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
          document.getElementById('create-channel-modal').style.display = 'none';
          loadChannelList();
        } catch(e) { alert('ìƒì„± ì‹¤íŒ¨: ' + e.message); }
      }

      window.enterChannel = async function(id, truePw, name) {
        const inputPw = prompt(`[${name}] ê³µëŒ€ì— ì ‘ì†í•˜ë ¤ë©´\nì±„ë„ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`);
        if(inputPw !== truePw) return alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        window.currentChannelId = id;
        document.getElementById('login-channel-name').innerText = name + " ë¡œê·¸ì¸";
        document.getElementById('app-guild-name').innerText = name;
        setupChannelListener(id);
        document.getElementById('lobby-view').style.display = 'none';
        document.getElementById('login-view').style.display = 'flex';
      }

      function setupChannelListener(channelId) {
        const docRef = doc(db, 'artifacts', ROOT_APP_ID, 'public', 'data', 'raid_channels', channelId);
        onSnapshot(docRef, (snap) => {
          if(snap.exists()){
            const d = snap.data();
            if(d.records) window.appData = JSON.parse(d.records);
            if(d.pool) window.allMembers = JSON.parse(d.pool);
            if(d.members) window.localMembers = JSON.parse(d.members);
            refreshUI();
          }
        });
      }

      window.saveAllData = async function() {
        if(!window.currentChannelId) return;
        const docRef = doc(db, 'artifacts', ROOT_APP_ID, 'public', 'data', 'raid_channels', window.currentChannelId);
        await setDoc(docRef, { records: JSON.stringify(window.appData), pool: JSON.stringify(window.allMembers), members: JSON.stringify(window.localMembers) }, { merge: true });
        document.getElementById('save-toast').classList.add('show');
        setTimeout(()=>document.getElementById('save-toast').classList.remove('show'), 2000);
      }

      function refreshUI() {
        if(document.getElementById('main-app').style.display==='block') {
            loadMembers();
            if(document.getElementById('gu-tb')) renGu();
            if(document.getElementById('lo-tb')) renLo();
            if(document.getElementById('en-tb')) renEn();
            if(document.getElementById('ch-tb')) renCh();
            // NEW: ì •ì‚° í™”ë©´ ê°±ì‹ 
            if(document.getElementById('raid-session-list')) renderRaidSessions();
        }
      }

      // --- [NEW: ê³ ê¸‰ ë¶„ë°° ì‹œìŠ¤í…œ] ---
      
      window.openAdvancedDistribution = function() {
        const h = `
          <div id="dist-main-view">
             <div style="margin-bottom:20px; text-align:right;">
                ${window.isAdmin ? `<button class="form-submit-btn" style="width:auto; padding:10px 20px;" onclick="openCreateRaidSession()">+ ì •ì‚° íšŒì°¨ ìƒì„± (Raid Open)</button>` : ''}
             </div>
             <div id="raid-session-list"></div>
          </div>
        `;
        showContent('ğŸ’° í†µí•© ì •ì‚° ì‹œìŠ¤í…œ', h);
        renderRaidSessions();
      }

      window.renderRaidSessions = function() {
        const c = document.getElementById('raid-session-list');
        if(!c) return;
        
        const raids = window.appData.raidSessions || [];
        if(raids.length === 0) {
            c.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">ì§„í–‰ ì¤‘ì¸ ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.<br>ê´€ë¦¬ìê°€ ì •ì‚° íšŒì°¨ë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.</div>';
            return;
        }

        c.innerHTML = raids.map((raid, idx) => {
            // ì •ì‚° ê³„ì‚°
            let totalIncome = 0;
            let totalDistributed = 0;
            raid.items.forEach(item => {
                totalIncome += item.netIncome; // ìˆ˜ìˆ˜ë£Œ ë—€ ìˆœìˆ˜ìµ
                totalDistributed += item.finalPot; // ë¶„ë°° ëŒ€ìƒ ê¸ˆì•¡
            });
            const unsoldCnt = raid.items.filter(i => !i.isSold).length;

            return `
            <div class="raid-card">
               <div class="raid-card-header">
                  <div>
                    <span class="raid-title">${raid.name}</span> <span style="font-size:12px;color:#888;">(${raid.date})</span>
                  </div>
                  <span class="raid-status ${raid.closed ? 'status-closed' : 'status-open'}">${raid.closed ? 'ì •ì‚° ë§ˆê°' : 'ì •ì‚° ì§„í–‰ì¤‘'}</span>
               </div>
               <div class="raid-stat-box">
                  <div class="stat-item">ì°¸ì—¬<br><span style="color:#333;font-weight:bold;">${raid.members.length}ëª…</span></div>
                  <div class="stat-item">ë“±ë¡ ë¬¼í’ˆ<br><span style="color:#333;font-weight:bold;">${raid.items.length}ê°œ</span></div>
                  <div class="stat-item">ë¯¸íŒë§¤<br><span style="color:${unsoldCnt>0?'red':'#999'};font-weight:bold;">${unsoldCnt}ê°œ</span></div>
               </div>
               <div style="display:flex; gap:10px;">
                  <button class="action-btn btn-info" style="flex:1; padding:10px;" onclick="viewRaidDetail(${idx})">ì •ì‚° ìƒì„¸ ë‚´ì—­ ë³´ê¸°</button>
                  ${window.isAdmin ? `<button class="action-btn btn-del" style="width:40px;" onclick="deleteRaidSession(${idx})">Ã—</button>` : ''}
               </div>
            </div>`;
        }).join('');
      }

      // íšŒì°¨ ìƒì„± ëª¨ë‹¬ ì—´ê¸°
      window.openCreateRaidSession = function() {
         const today = getTodayStr();
         
         // 1. ì´ˆê¸° ì„ íƒ ì¸ì›: í˜„ì¬ íŒŒí‹°ì›(localMembers)ì„ ê¸°ë³¸ìœ¼ë¡œ ì„ íƒ
         window.newRaidSelectedMembers = window.localMembers.map(m => m[0]); // ë‹‰ë„¤ì„ë§Œ ì¶”ì¶œ

         const h = `
           <div class="form-group">
              <label class="form-label">íšŒì°¨ ì´ë¦„</label>
              <input type="text" id="rs-name" class="form-control" value="í˜¼í…Œì¼ ì •ê·œê³µëŒ€">
           </div>
           <div class="form-group">
              <label class="form-label">ë‚ ì§œ</label>
              <input type="date" id="rs-date" class="form-control" value="${today}">
           </div>
           
           <!-- ì°¸ì—¬ ì¸ì› ì„ íƒ (ì „ì²´ ì¸ì›ì—ì„œ ì„ íƒ) -->
           <div class="form-group">
              <label class="form-label">ì°¸ì—¬ ì¸ì› ì„ íƒ (í´ë¦­í•˜ì—¬ ì„ íƒ/í•´ì œ)</label>
              <div id="select-member-pool" class="select-member-pool"></div>
           </div>

           <!-- íŒ¨ë„í‹°/ì§€ë¶„ ì„¤ì • (ì„ íƒëœ ì¸ì›ë§Œ í‘œì‹œ) -->
           <div class="form-group">
              <label class="form-label">íŒ¨ë„í‹°/ì§€ë¶„ ì„¤ì •</label>
              <div id="penalty-config-area" style="max-height:200px; overflow-y:auto; border:1px solid #eee; padding:10px; border-radius:8px; background:#fafafa;">
                 <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
              </div>
              <p style="font-size:11px; color:#888; margin-top:5px;">* ì´ ì„¤ì •ì€ í•´ë‹¹ íšŒì°¨ ë™ì•ˆ ë³€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì§ì ‘ ì…ë ¥ ê°€ëŠ¥.</p>
           </div>
           <button class="form-submit-btn" onclick="submitRaidSession()">íšŒì°¨ ìƒì„± ë° ëª…ë¶€ í™•ì •</button>
         `;
         showContent('ğŸ†• ì •ì‚° íšŒì°¨ ìƒì„±', h);
         renderCreateSessionMembers();
      }

      // íšŒì°¨ ìƒì„±ì°½ì˜ ë©¤ë²„ ë Œë”ë§
      window.renderCreateSessionMembers = function() {
          // 1. ë©¤ë²„ í’€ ë Œë”ë§
          const poolDiv = document.getElementById('select-member-pool');
          if(poolDiv) {
              poolDiv.innerHTML = window.allMembers.map(m => {
                  const isSelected = window.newRaidSelectedMembers.includes(m.nick);
                  return `<div class="select-chip ${isSelected ? 'selected' : ''}" onclick="toggleRaidMember('${m.nick}')">${m.nick}</div>`;
              }).join('');
          }

          // 2. íŒ¨ë„í‹° ì„¤ì • ì˜ì—­ ë Œë”ë§ (ì„ íƒëœ ë©¤ë²„ë§Œ)
          const configDiv = document.getElementById('penalty-config-area');
          if(configDiv) {
              if (window.newRaidSelectedMembers.length === 0) {
                  configDiv.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ì„ íƒëœ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                  return;
              }
              
              configDiv.innerHTML = window.newRaidSelectedMembers.map((nick, i) => {
                  // í•´ë‹¹ ë‹‰ë„¤ì„ì˜ ì§ì—… ì •ë³´ ì°¾ê¸°
                  const memberInfo = window.allMembers.find(m => m.nick === nick);
                  const job = memberInfo ? memberInfo.job : 'ì•Œìˆ˜ì—†ìŒ';

                  return `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; background:#fff; padding:6px; border-radius:6px; border:1px solid #eee;">
                       <span style="font-weight:bold; font-size:13px;">${nick} <span style="font-weight:normal;color:#888;font-size:11px;">(${job})</span></span>
                       <div class="share-control">
                          <input type="number" id="penalty-${i}" class="share-input" step="0.01" value="1.0" data-nick="${nick}" data-job="${job}">
                          <select class="share-select" onchange="document.getElementById('penalty-${i}').value=this.value">
                             <option value="1.0" selected>ì •ìƒ (1.0)</option>
                             <optgroup label="ì¸ì„¼í‹°ë¸Œ (ê²½í—˜ì¹˜)">
                                <option value="1.01">+1% (1.01)</option>
                                <option value="1.02">+2% (1.02)</option>
                                <option value="1.03">+3% (1.03)</option>
                                <option value="1.04">+4% (1.04)</option>
                                <option value="1.05">ê³µëŒ€ì¥ (1.05)</option>
                             </optgroup>
                             <optgroup label="íŒ¨ë„í‹° (ì°¨ê°)">
                                <option value="0.9">10% ì°¨ê° (0.9)</option>
                                <option value="0.8">20% ì°¨ê° (0.8)</option>
                                <option value="0.7">30% ì°¨ê° (0.7)</option>
                                <option value="0.6">40% ì°¨ê° (0.6)</option>
                                <option value="0.5">50% ì°¨ê° (0.5)</option>
                                <option value="0.4">60% ì°¨ê° (0.4)</option>
                                <option value="0.3">70% ì°¨ê° (0.3)</option>
                                <option value="0.2">80% ì°¨ê° (0.2)</option>
                                <option value="0.1">90% ì°¨ê° (0.1)</option>
                                <option value="0.0">ë¶„ë°° ì œì™¸ (0.0)</option>
                             </optgroup>
                             <option value="">ì§ì ‘ì…ë ¥</option>
                          </select>
                       </div>
                    </div>`;
              }).join('');
          }
      }

      window.toggleRaidMember = function(nick) {
          const idx = window.newRaidSelectedMembers.indexOf(nick);
          if (idx > -1) {
              window.newRaidSelectedMembers.splice(idx, 1);
          } else {
              window.newRaidSelectedMembers.push(nick);
          }
          renderCreateSessionMembers();
      }

      window.submitRaidSession = function() {
         const name = document.getElementById('rs-name').value;
         const date = document.getElementById('rs-date').value;
         
         if (window.newRaidSelectedMembers.length === 0) return alert('ì°¸ì—¬ ì¸ì›ì„ ìµœì†Œ 1ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');

         // ëª…ë¶€ í™•ì • (ìŠ¤ëƒ…ìƒ·)
         // DOMì—ì„œ ì…ë ¥ëœ ì§€ë¶„ ê°’ì„ ì½ì–´ì™€ì•¼ í•¨
         const members = window.newRaidSelectedMembers.map((nick, i) => {
             const input = document.getElementById(`penalty-${i}`);
             return {
                 nick: nick,
                 job: input.dataset.job,
                 share: parseFloat(input.value) || 0
             };
         });

         if(!window.appData.raidSessions) window.appData.raidSessions = [];
         window.appData.raidSessions.unshift({
             id: 'rs_' + Date.now(),
             name: name,
             date: date,
             members: members,
             items: [], // íŒë§¤ ì•„ì´í…œë“¤
             payouts: [], // [ë³µêµ¬ëœ ê¸°ëŠ¥] ê°œë³„ ì§€ê¸‰ ë¡œê·¸
             closed: false
         });
         
         saveAllData();
         openAdvancedDistribution();
      }

      window.deleteRaidSession = function(idx) {
          if(confirm('ì´ íšŒì°¨ì˜ ëª¨ë“  ì •ì‚° ê¸°ë¡ì´ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
              window.appData.raidSessions.splice(idx, 1);
              saveAllData();
              renderRaidSessions();
          }
      }

      // --- [íšŒì°¨ ìƒì„¸ ë³´ê¸° & ì•„ì´í…œ ì¶”ê°€] ---
      window.viewRaidDetail = function(idx) {
          const raid = window.appData.raidSessions[idx];
          if(!raid.payouts) raid.payouts = []; // êµ¬ë²„ì „ ë°ì´í„° í˜¸í™˜
          window.currentRaidId = idx;

          // ì´ ì§€ë¶„ í•©ê³„
          const totalShares = raid.members.reduce((sum, m) => sum + m.share, 0);

          let h = `
          <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
             <div><b style="font-size:16px;">${raid.name}</b> <span style="color:#888; font-size:12px;">(${raid.date})</span></div>
             <button class="action-btn btn-outline" onclick="openAdvancedDistribution()">ëª©ë¡ìœ¼ë¡œ</button>
          </div>
          
          <!-- ì•„ì´í…œ ëª©ë¡ -->
          <div style="margin-bottom:20px;">
             <h4 style="margin:0 0 10px 0;">ğŸ“¦ íŒë§¤/ìˆ˜ì… ë‚´ì—­</h4>
             ${window.isAdmin ? `<button class="form-submit-btn" style="margin-bottom:10px; font-size:12px; padding:8px;" onclick="openAddItemModal(${idx})">+ ì•„ì´í…œ/ìˆ˜ì… ë“±ë¡</button>` : ''}
             
             <div class="table-wrapper">
               <table class="record-table">
                  <thead><tr><th>í’ˆëª©</th><th>íŒë§¤ê°€</th><th>ìˆœìˆ˜ìµ</th><th>ê³µì œ/ì¸ì„¼</th><th>Në¹µ ê¸ˆì•¡</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                  <tbody>
                    ${raid.items.map((item, iIdx) => {
                        const deduction = (item.referral?.amount || 0) + (item.incentive?.amount || 0);
                        return `<tr>
                          <td>${item.name}</td>
                          <td>${item.price.toLocaleString()}</td>
                          <td style="color:#1890ff">${item.netIncome.toLocaleString()}</td>
                          <td style="color:#ff4d4f">-${deduction.toLocaleString()}</td>
                          <td style="font-weight:bold;">${Math.floor(item.finalPot / totalShares).toLocaleString()}</td>
                          <td>${item.isSold ? '<span style="color:#52c41a">ì •ì‚°ì™„ë£Œ</span>' : '<span style="color:red">ë¯¸íŒë§¤</span>'}</td>
                          <td>${window.isAdmin ? `<button class="action-btn btn-del" onclick="delRaidItem(${idx}, ${iIdx})">Ã—</button>` : '-'}</td>
                        </tr>`;
                    }).join('') || '<tr><td colspan="7" class="record-empty">ë“±ë¡ëœ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'}
                  </tbody>
               </table>
             </div>
          </div>

          <!-- ê°œì¸ë³„ ì •ì‚°í‘œ & ì§€ê¸‰ ê´€ë¦¬ -->
          <div>
             <h4 style="margin:0 0 10px 0;">ğŸ’° ê°œì¸ë³„ ìµœì¢… ìˆ˜ë ¹ì•¡ ë° ì§€ê¸‰ ê´€ë¦¬</h4>
             <div class="table-wrapper" style="max-height:300px; overflow-y:auto;">
               <table class="record-table">
                  <thead><tr><th>ë‹‰ë„¤ì„</th><th>ì§€ë¶„</th><th>ìµœì¢…ìˆ˜ë ¹ì•¡</th><th>ê¸°ì§€ê¸‰ì•¡</th><th>ì”ì•¡</th><th>ê´€ë¦¬</th></tr></thead>
                  <tbody>
                    ${raid.members.map(m => {
                        // 1. ìˆ˜ë ¹ì•¡ ê³„ì‚°
                        let basePayout = 0;
                        let extraPayout = 0;
                        
                        raid.items.forEach(item => {
                            if(!item.isSold) return;
                            const shareVal = item.finalPot / totalShares;
                            basePayout += Math.floor(shareVal * m.share);
                            if(item.referral?.active && item.referral.to === m.nick) extraPayout += item.referral.amount;
                            if(item.incentive?.active && item.incentive.to === m.nick) extraPayout += item.incentive.amount;
                        });
                        const totalDue = basePayout + extraPayout;

                        // 2. ê¸°ì§€ê¸‰ì•¡ ê³„ì‚°
                        const paidAmount = raid.payouts
                            .filter(p => p.to === m.nick)
                            .reduce((sum, p) => sum + p.amount, 0);
                        
                        const balance = totalDue - paidAmount;

                        return `<tr>
                          <td style="font-weight:bold;">${m.nick}</td>
                          <td><span style="font-size:11px; background:#f0f0f0; padding:2px 5px; border-radius:4px;">${m.share}</span></td>
                          <td style="font-weight:800; color:#ff6b00;">${totalDue.toLocaleString()}</td>
                          <td style="color:#1890ff">${paidAmount > 0 ? paidAmount.toLocaleString() : '-'}</td>
                          <td style="font-weight:bold; color:${balance > 0 ? '#ff4d4f' : '#ccc'}">${balance.toLocaleString()}</td>
                          <td>
                            ${window.isAdmin && balance !== 0 ? 
                                `<button class="action-btn btn-pay" onclick="setRaidPayoutTarget('${m.nick}', ${balance})">ì •ì‚°</button>` : 
                                (balance === 0 && totalDue > 0 ? 'ì™„ë£Œ' : '-')
                            }
                          </td>
                        </tr>`;
                    }).join('')}
                  </tbody>
               </table>
             </div>
          </div>

          <!-- [ë³µêµ¬ëœ ê¸°ëŠ¥] ì§€ê¸‰ ì²˜ë¦¬ íŒ¨ë„ -->
          <div class="payout-panel">
             <div class="payout-title">ğŸ’¸ ì§€ê¸‰ ì²˜ë¦¬</div>
             <div class="form-row">
                <input type="text" id="pay-target-nick" class="form-control" placeholder="ë‹‰ë„¤ì„ (ì •ì‚° ë²„íŠ¼ í´ë¦­)" readonly style="width:120px; background:#f9f9f9;">
                <input type="number" id="pay-target-amt" class="form-control" placeholder="ì§€ê¸‰í•  ê¸ˆì•¡" style="flex:1;">
                <button class="form-submit-btn" style="width:100px; margin-top:0;" onclick="submitRaidPayout(${idx})">ì§€ê¸‰ í™•ì •</button>
             </div>
             
             <!-- ì§€ê¸‰ ë¡œê·¸ -->
             <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                <div style="font-size:12px; font-weight:bold; color:#666; margin-bottom:5px;">ğŸ“‹ ìµœê·¼ ì§€ê¸‰ ë‚´ì—­</div>
                <div style="max-height:150px; overflow-y:auto;">
                    <table class="record-table" style="font-size:11px;">
                        ${raid.payouts.length > 0 ? 
                            raid.payouts.slice().reverse().map((log, pIdx) => `
                                <tr>
                                    <td style="color:#999;">${log.date}</td>
                                    <td><b>${log.to}</b>ë‹˜ì—ê²Œ</td>
                                    <td style="color:#1890ff; font-weight:bold;">${log.amount.toLocaleString()}</td>
                                    <td>ì§€ê¸‰ì™„ë£Œ</td>
                                    <td>${window.isAdmin ? `<button class="action-btn btn-del" onclick="deleteRaidPayout(${idx}, ${raid.payouts.length - 1 - pIdx})">Ã—</button>` : ''}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="5" style="text-align:center; color:#ccc;">ì§€ê¸‰ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'
                        }
                    </table>
                </div>
             </div>
          </div>
          `;
          showContent('ğŸ§¾ ì •ì‚° ìƒì„¸ ë‚´ì—­', h);
      }

      // ì§€ê¸‰ ëŒ€ìƒ ì„¤ì • (ì •ì‚° ë²„íŠ¼ í´ë¦­ ì‹œ)
      window.setRaidPayoutTarget = function(nick, balance) {
          document.getElementById('pay-target-nick').value = nick;
          document.getElementById('pay-target-amt').value = balance;
      }

      // ì§€ê¸‰ í™•ì • ì²˜ë¦¬
      window.submitRaidPayout = function(raidIdx) {
          const nick = document.getElementById('pay-target-nick').value;
          const amt = parseInt(document.getElementById('pay-target-amt').value);

          if (!nick || !amt || amt === 0) return alert('ì§€ê¸‰ ëŒ€ìƒê³¼ ê¸ˆì•¡ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');

          const raid = window.appData.raidSessions[raidIdx];
          if (!raid.payouts) raid.payouts = [];

          raid.payouts.push({
              date: new Date().toLocaleString(),
              to: nick,
              amount: amt
          });

          saveAllData();
          viewRaidDetail(raidIdx); // í™”ë©´ ê°±ì‹ 
      }

      // ì§€ê¸‰ ë‚´ì—­ ì‚­ì œ
      window.deleteRaidPayout = function(raidIdx, pIdx) {
          if(confirm('ì´ ì§€ê¸‰ ë‚´ì—­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì”ì•¡ì´ ë‹¤ì‹œ ë³µêµ¬ë©ë‹ˆë‹¤.')) {
              window.appData.raidSessions[raidIdx].payouts.splice(pIdx, 1);
              saveAllData();
              viewRaidDetail(raidIdx);
          }
      }

      window.openAddItemModal = function(raidIdx) {
          const raid = window.appData.raidSessions[raidIdx];
          const membersOptions = raid.members.map(m => `<option value="${m.nick}">${m.nick}</option>`).join('');

          const h = `
          <div style="padding:5px;">
             <div class="form-group">
                <label class="form-label">ì•„ì´í…œ ì´ë¦„</label>
                <input type="text" id="ai-name" class="form-control" placeholder="ì˜ˆ: ì•Œí˜¼ëª©">
             </div>
             <div class="form-group">
                <label class="form-label">íŒë§¤ ê¸ˆì•¡</label>
                <input type="number" id="ai-price" class="form-control" placeholder="ë©”ì†Œ ì…ë ¥" oninput="calcPreview()">
             </div>
             <div class="form-group">
                <label class="form-label">ê±°ë˜ ë°©ì‹ (ìˆ˜ìˆ˜ë£Œ)</label>
                <select id="ai-trade-type" class="form-control" onchange="calcPreview()">
                   <option value="trade">1:1 êµí™˜ (ì¼ë°˜)</option>
                   <option value="trade_99">1:1 êµí™˜ (99ìˆ˜ì‘ - 0.8%)</option>
                   <option value="trade_499">1:1 êµí™˜ (499ìˆ˜ì‘ - 1.8%)</option>
                   <option value="trade_999">1:1 êµí™˜ (999ìˆ˜ì‘ - 3%)</option>
                   <option value="trade_2499">1:1 êµí™˜ (2499ìˆ˜ì‘ - 4%)</option>
                   <option value="parcel">ìš°í¸ ëŒ€ê¸ˆì²­êµ¬</option>
                   <option value="none">ìˆ˜ìˆ˜ë£Œ ì—†ìŒ (0%)</option>
                </select>
             </div>
             
             <!-- ê³ ê¸‰ ì˜µì…˜ -->
             <div class="item-add-box">
                <div style="font-size:12px; font-weight:bold; color:#ff6b00; margin-bottom:5px;">ê³ ê¸‰ ì˜µì…˜ (ì„ íƒ)</div>
                
                <div class="toggle-option">
                   <input type="checkbox" id="chk-referral" onchange="toggleOption('referral')">
                   <div style="flex:1">
                      <label for="chk-referral" style="font-size:13px; font-weight:bold; cursor:pointer;">ì†Œê°œë¹„/ì•Œì„ ë¹„ ì ìš©</label>
                      <div id="opt-referral" style="display:none; margin-top:5px;">
                         <div class="form-row">
                             <select id="ref-to" class="form-control" style="font-size:12px;">${membersOptions}</select>
                             <input type="number" id="ref-amt" class="form-control" placeholder="ê³ ì •ê¸ˆì•¡" oninput="calcPreview()">
                         </div>
                      </div>
                   </div>
                </div>

                <div class="toggle-option">
                   <input type="checkbox" id="chk-incen" onchange="toggleOption('incen')">
                   <div style="flex:1">
                      <label for="chk-incen" style="font-size:13px; font-weight:bold; cursor:pointer;">íŒë§¤ ì¸ì„¼í‹°ë¸Œ (%)</label>
                      <div id="opt-incen" style="display:none; margin-top:5px;">
                         <div class="form-row">
                             <select id="inc-to" class="form-control" style="font-size:12px;">${membersOptions}</select>
                             <input type="number" id="inc-rate" class="form-control" placeholder="%" value="5" oninput="calcPreview()">
                         </div>
                         <div style="font-size:11px; color:#888; margin-top:2px;">* ìˆœìˆ˜ìµì˜ N%ê°€ ì§€ê¸‰ë©ë‹ˆë‹¤.</div>
                      </div>
                   </div>
                </div>
             </div>

             <!-- ê³„ì‚° ë¯¸ë¦¬ë³´ê¸° -->
             <div style="margin-top:20px; background:#fafafa; padding:15px; border-radius:8px;">
                <div class="calc-row"><span>íŒë§¤ê¸ˆì•¡</span> <span id="prev-price">0</span></div>
                <div class="calc-row"><span>(-) ìˆ˜ìˆ˜ë£Œ</span> <span id="prev-tax" class="minus-val">0</span></div>
                <div class="calc-row" style="border-bottom:1px solid #ddd; padding-bottom:4px; margin-bottom:4px;"><span>(=) ìˆœìˆ˜ìµ</span> <span id="prev-net" style="font-weight:bold;">0</span></div>
                
                <div class="calc-row"><span>(-) ì†Œê°œë¹„</span> <span id="prev-ref" class="minus-val">0</span></div>
                <div class="calc-row"><span>(-) ì¸ì„¼í‹°ë¸Œ</span> <span id="prev-inc" class="minus-val">0</span></div>
                
                <div class="calc-row final"><span>ğŸ’° ìµœì¢… ë¶„ë°° íŒŒì´</span> <span id="prev-final">0</span></div>
             </div>
             
             <button class="form-submit-btn" onclick="submitRaidItem(${raidIdx})">ë“±ë¡í•˜ê¸°</button>
          </div>
          `;
          showContent('ğŸ“¦ ì•„ì´í…œ ë“±ë¡', h);
      }

      window.getFee = function(amount, type) {
          if (type === 'none') return 0;
          if (type === 'trade_99') return Math.floor(amount * 0.008);
          if (type === 'trade_499') return Math.floor(amount * 0.018);
          if (type === 'trade_999') return Math.floor(amount * 0.03);
          if (type === 'trade_2499') return Math.floor(amount * 0.04);
          
          let rate = 0;
          if (type === 'trade') {
             if(amount >= 100000000) rate = 0.06;
             else if(amount >= 25000000) rate = 0.05;
             else if(amount >= 10000000) rate = 0.04;
             else if(amount >= 5000000) rate = 0.03;
             else if(amount >= 1000000) rate = 0.018;
             else if(amount >= 100000) rate = 0.008;
          } else if (type === 'parcel') {
             if(amount >= 100000000) rate = 0.07;
             else if(amount >= 25000000) rate = 0.06;
             else if(amount >= 10000000) rate = 0.05;
             else if(amount >= 5000000) rate = 0.04;
             else if(amount >= 1000000) rate = 0.027;
             else if(amount >= 100000) rate = 0.012;
          }
          return Math.floor(amount * rate);
      }

      window.toggleOption = function(type) {
          const chk = document.getElementById(type === 'referral' ? 'chk-referral' : 'chk-incen');
          const div = document.getElementById(type === 'referral' ? 'opt-referral' : 'opt-incen');
          div.style.display = chk.checked ? 'block' : 'none';
          calcPreview();
      }

      window.calcPreview = function() {
          const price = parseInt(document.getElementById('ai-price').value) || 0;
          const tradeType = document.getElementById('ai-trade-type').value;
          
          const tax = getFee(price, tradeType);
          const net = price - tax;

          let refAmt = 0;
          if(document.getElementById('chk-referral').checked) {
              refAmt = parseInt(document.getElementById('ref-amt').value) || 0;
          }

          let incAmt = 0;
          if(document.getElementById('chk-incen').checked) {
              const rate = parseFloat(document.getElementById('inc-rate').value) || 0;
              incAmt = Math.floor(net * (rate / 100)); // ìˆœìˆ˜ìµ ê¸°ì¤€ %
          }

          const final = net - refAmt - incAmt;

          document.getElementById('prev-price').innerText = price.toLocaleString();
          document.getElementById('prev-tax').innerText = '-' + tax.toLocaleString();
          document.getElementById('prev-net').innerText = net.toLocaleString();
          document.getElementById('prev-ref').innerText = refAmt > 0 ? '-' + refAmt.toLocaleString() : '0';
          document.getElementById('prev-inc').innerText = incAmt > 0 ? '-' + incAmt.toLocaleString() : '0';
          document.getElementById('prev-final').innerText = final.toLocaleString();
          
          return { price, net, refAmt, incAmt, final };
      }

      window.submitRaidItem = function(raidIdx) {
          const name = document.getElementById('ai-name').value;
          if(!name) return alert('ì•„ì´í…œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
          
          const vals = calcPreview();
          if(vals.price <= 0) return alert('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');

          const newItem = {
              name: name,
              price: vals.price,
              netIncome: vals.net,
              finalPot: vals.final,
              isSold: true, // ë“±ë¡ ì¦‰ì‹œ íŒë§¤ëœ ê²ƒìœ¼ë¡œ ê°„ì£¼ (ë‚˜ì¤‘ì— ë¯¸íŒë§¤ ê¸°ëŠ¥ í™•ì¥ ê°€ëŠ¥)
              referral: {
                  active: document.getElementById('chk-referral').checked,
                  to: document.getElementById('ref-to').value,
                  amount: vals.refAmt
              },
              incentive: {
                  active: document.getElementById('chk-incen').checked,
                  to: document.getElementById('inc-to').value,
                  rate: parseFloat(document.getElementById('inc-rate').value) || 0,
                  amount: vals.incAmt
              }
          };

          window.appData.raidSessions[raidIdx].items.push(newItem);
          saveAllData();
          viewRaidDetail(raidIdx); // ìƒì„¸ í™”ë©´ìœ¼ë¡œ ë³µê·€
      }

      window.delRaidItem = function(rIdx, iIdx) {
          if(confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              window.appData.raidSessions[rIdx].items.splice(iIdx, 1);
              saveAllData();
              viewRaidDetail(rIdx);
          }
      }

      // --- [ê¸°ì¡´ ê¸°ëŠ¥ë“¤ (ìœ ì§€)] ---
      
      /* [ê¸°íƒ€ ì¹´í…Œê³ ë¦¬] */
      window.openChannelHistory = () => { showContent('ğŸ“¢ ì˜¤ëŠ˜ì˜ ì±„ë„', `<div class="table-wrapper">${genTable('ch-tb',['ë‚ ì§œ','ë¦¬í”„ë ˆ','ì›ì •ëŒ€','ê´€ë¦¬'])}</div>` + (window.isAdmin?`<div class="form-group"><div class="form-row"><input type="date" id="ch-d" class="form-control" value="${getTodayStr()}"><input type="text" id="ch-v1" class="form-control" placeholder="ë¦¬í”„ë ˆ"><input type="text" id="ch-v2" class="form-control" placeholder="ì›ì •ëŒ€"></div><button class="form-submit-btn" onclick="addCh()">ë“±ë¡</button></div>`:'')); renCh(); }
      window.addCh = () => { window.appData.channel.unshift({date:document.getElementById('ch-d').value, v1:document.getElementById('ch-v1').value, v2:document.getElementById('ch-v2').value}); saveAllData(); renCh(); }
      window.renCh = () => { document.getElementById('ch-tb').innerHTML = window.appData.channel.map((c,i)=>`<tr><td>${c.date}</td><td>${c.v1}</td><td>${c.v2}</td><td>${window.isAdmin?`<button class="action-btn btn-del" onclick="deleteRecord('channel',${i})">Ã—</button>`:'-'}</td></tr>`).join('')||'<tr><td colspan="4">ì—†ìŒ</td></tr>'; }

      window.openEntryTimeHistory = () => { showContent('â° ì…ì¥ ì‹œê°„', `<div class="table-wrapper">${genTable('en-tb',['ë‚ ì§œ','ì•Œë²„í”„','ì˜ë©”','ì…ì¥','ê´€ë¦¬'])}</div>` + (window.isAdmin?`<div class="form-group"><div class="form-row"><input type="date" id="en-d" class="form-control" value="${getTodayStr()}"><input type="text" id="en-a" class="form-control" placeholder="ì•Œ"><input type="text" id="en-y" class="form-control" placeholder="ì˜"><input type="text" id="en-t" class="form-control" placeholder="ì…"></div><button class="form-submit-btn" onclick="addEn()">ë“±ë¡</button></div>`:'')); renEn(); }
      window.addEn = () => { window.appData.entry.unshift({date:document.getElementById('en-d').value, al:document.getElementById('en-a').value, ym:document.getElementById('en-y').value, time:document.getElementById('en-t').value}); saveAllData(); renEn(); }
      window.renEn = () => { document.getElementById('en-tb').innerHTML = window.appData.entry.map((e,i)=>`<tr><td>${e.date}</td><td>${e.al}</td><td>${e.ym}</td><td>${e.time}</td><td>${window.isAdmin?`<button class="action-btn btn-del" onclick="deleteRecord('entry',${i})">Ã—</button>`:'-'}</td></tr>`).join('')||'<tr><td colspan="5">ì—†ìŒ</td></tr>'; }

      window.openGuestHistory = () => { showContent('ğŸ« ì†ë‹˜ ì •ë³´', `<div class="table-wrapper">${genTable('gu-tb',['ë‚ ì§œ','ë‹‰ë„¤ì„','ì†Œê°œ','í’ˆëª©','ê¸ˆì•¡','ë²„í”„','ê´€ë¦¬'])}</div>` + (window.isAdmin?`<div class="form-group"><div class="form-row"><input type="date" id="gu-d" class="form-control" value="${getTodayStr()}"><input type="text" id="gu-n" class="form-control" placeholder="ë‹‰ë„¤ì„"><input type="text" id="gu-i" class="form-control" placeholder="ì†Œê°œ"></div><div class="form-row"><input type="text" id="gu-it" class="form-control" placeholder="í’ˆëª©"><input type="number" id="gu-a" class="form-control" placeholder="ê¸ˆì•¡"><select id="gu-b" class="form-control"><option>ë°˜ë‚©</option><option>ë¯¸ë°˜ë‚©</option></select></div><button class="form-submit-btn" onclick="addGu()">ë“±ë¡</button></div>`:'')); renGu(); }
      window.addGu = () => { window.appData.guest.unshift({date:document.getElementById('gu-d').value, nick:document.getElementById('gu-n').value, intro:document.getElementById('gu-i').value, item:document.getElementById('gu-it').value, amt:document.getElementById('gu-a').value, buff:document.getElementById('gu-b').value}); saveAllData(); renGu(); }
      window.renGu = () => { document.getElementById('gu-tb').innerHTML = window.appData.guest.map((g,i)=>`<tr><td>${g.date}</td><td>${g.nick}</td><td>${g.intro}</td><td>${g.item}</td><td>${parseInt(g.amt||0).toLocaleString()}</td><td>${g.buff}</td><td>${window.isAdmin?`<button class="action-btn btn-del" onclick="deleteRecord('guest',${i})">Ã—</button>`:'-'}</td></tr>`).join('')||'<tr><td colspan="7">ì—†ìŒ</td></tr>'; }

      window.openLootHistory = () => { showContent('ğŸ’ ì „ë¦¬í’ˆ', `<div class="table-wrapper">${genTable('lo-tb',['ë‚ ì§œ','ë§ˆë¶','ì¥ë¹„','íŠ¹ì´ì‚¬í•­','ê´€ë¦¬'])}</div>` + (window.isAdmin?`<div class="form-group"><input type="date" id="lo-d" class="form-control" value="${getTodayStr()}"><input type="text" id="lo-m" class="form-control" placeholder="ë§ˆë¶"><input type="text" id="lo-e" class="form-control" placeholder="ì¥ë¹„"><input type="text" id="lo-n" class="form-control" placeholder="íŠ¹ì´ì‚¬í•­"><button class="form-submit-btn" onclick="addLo()">ë“±ë¡</button></div>`:'')); renLo(); }
      window.addLo = () => { window.appData.loot.unshift({date:document.getElementById('lo-d').value, mastery:document.getElementById('lo-m').value, equip:document.getElementById('lo-e').value, note:document.getElementById('lo-n').value}); saveAllData(); renLo(); }
      window.renLo = () => { document.getElementById('lo-tb').innerHTML = window.appData.loot.map((l,i)=>`<tr><td>${l.date}</td><td>${l.mastery}</td><td>${l.equip}</td><td>${l.note}</td><td>${window.isAdmin?`<button class="action-btn btn-del" onclick="deleteRecord('loot',${i})">Ã—</button>`:'-'}</td></tr>`).join('')||'<tr><td colspan="5">ì—†ìŒ</td></tr>'; }

      /* [ì—°ì°¨ & ê¸°íƒ€] */
      window.openLeaveCalendar = function() {
        const now = new Date(); const y = now.getFullYear(); const m = now.getMonth(); const fd = new Date(y, m, 1).getDay(); const ld = new Date(y, m + 1, 0).getDate();
        let h = `<div style="text-align:center;font-weight:bold;margin-bottom:10px;">${y}ë…„ ${m+1}ì›”</div><div class="calendar-container"><div class="calendar-grid">`;
        ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d=>h+=`<div class="calendar-header">${d}</div>`);
        for(let i=0; i<fd; i++) h += `<div class="calendar-day"></div>`;
        for(let d=1; d<=ld; d++) {
          const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const b = window.appData.leaves.filter(l=>l.date===ds).map(l=>`<span class="leave-badge ${l.role==='admin'?'admin':''}" onclick="delLeave(event,'${ds}','${l.nick}')">${l.nick}Ã—</span>`).join('');
          h += `<div class="calendar-day" onclick="addLeave('${ds}')"><span class="day-num">${d}</span>${b}</div>`;
        }
        showContent('ğŸ“… ì—°ì°¨ ì‹ ì²­', h+'</div></div>');
      }
      window.addLeave = (d) => { const n=prompt(`${d} ì—°ì°¨ ì‹ ì²­ì ì´ë¦„:`, window.currentUser); if(n){ window.appData.leaves.push({date:d, nick:n, role:window.userRole}); saveAllData(); openLeaveCalendar(); } }
      window.delLeave = (e,d,n) => { e.stopPropagation(); if(confirm('ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ const i=window.appData.leaves.findIndex(l=>l.date===d&&l.nick===n); if(i>-1){ window.appData.leaves.splice(i,1); saveAllData(); openLeaveCalendar(); } } }

      window.openMultiTimer = () => showContent('â±ï¸ íƒ€ì´ë¨¸', '<div style="text-align:center; padding:20px;">íƒ€ì´ë¨¸ ê¸°ëŠ¥ (ì¶”í›„ êµ¬í˜„)</div>');
      window.openGuestReviews = () => {
          const h = `<div style="background:#fff;padding:10px;border-radius:8px;margin-bottom:10px;"><div id="re-edit" class="review-editor" contenteditable="true" style="border:1px solid #ddd;min-height:80px;border-radius:4px;padding:5px;"></div><button class="form-submit-btn" onclick="saveRev()">ë“±ë¡</button></div><div id="re-list"></div>`;
          showContent('â­ ë¦¬ë·°', h); renRev();
      }
      window.saveRev = () => { window.appData.reviews.unshift({writer:window.currentUser, content:document.getElementById('re-edit').innerHTML, date:new Date().toLocaleString()}); saveAllData(); renRev(); }
      window.renRev = () => { document.getElementById('re-list').innerHTML = window.appData.reviews.map(r=>`<div style="background:#fff;padding:10px;border-bottom:1px solid #eee;"><b>${r.writer}</b> <span style="font-size:11px;color:#999;">${r.date}</span><br>${r.content}</div>`).join(''); }

      /* [íŒŒí‹° ê´€ë¦¬] */
      window.loadMembers = function() {
        const c=document.getElementById('member-list-container'); if(window.localMembers.length===0) return c.innerHTML='<div style="text-align:center;padding:20px;color:#999">íŒŒí‹°ì› ì—†ìŒ</div>';
        const grp={'1íŒŒí‹°':[],'2íŒŒí‹°':[],'3íŒŒí‹°':[],'ëŒ€ê¸°':[]};
        window.localMembers.forEach(m=>{ const j=getJobKey(m[1]); if(grp[m[3]])grp[m[3]].push({...{nick:m[0],job:m[1],lvl:m[2]}, cls:j}); });
        let h=''; Object.keys(grp).forEach(p=>{ if(grp[p].length){ h+=`<div class="party-header">${p}</div>`; grp[p].forEach(m=>{ h+=`<div class="member-item ${m.cls}"><div class="member-info"><span class="member-name">${m.nick}</span><span class="member-detail">${m.job}</span></div><div class="member-right"><span class="member-lv">Lv.${m.lvl}</span>${window.isAdmin?`<button class="delete-btn" onclick="delMem('${m.nick}')">Ã—</button>`:''}</div></div>`; }); } });
        c.innerHTML=h;
      }
      window.getJobKey = (j) => { if(j==='íˆì–´ë¡œ')return 'hero'; if(['ë‚˜ì´íŠ¸ë¡œë“œ','ì„€ë„ì–´'].some(k=>j.includes(k)))return 'thief'; if(['ë¹„ìˆ','ì•„í¬ë©”ì´ì§€'].some(k=>j.includes(k)))return 'mage'; if(['ë³´ìš°ë§ˆìŠ¤í„°','ì‹ ê¶'].some(k=>j.includes(k)))return 'archer'; if(j==='ë‹¤í¬ë‚˜ì´íŠ¸')return 'dk'; return ''; }
      window.delMem = (n) => { if(confirm('ì‚­ì œ?')){ window.localMembers=window.localMembers.filter(m=>m[0]!==n); saveAllData(); loadMembers(); } }
      window.resetParty = () => { if(confirm('ì´ˆê¸°í™”?')){ window.localMembers=[]; saveAllData(); loadMembers(); } }
      window.openAddMemberModal = () => { document.getElementById('add-member-modal').style.display='flex'; switchAddTab('pick'); renderEasySetup(); }
      window.closeAddModal = (e) => { if(e.target.id==='add-member-modal') e.target.style.display='none'; }
      window.switchAddTab = (t) => { document.getElementById('tab-btn-pick').className=t==='pick'?'tab-btn active':'tab-btn'; document.getElementById('tab-btn-single').className=t==='single'?'tab-btn active':'tab-btn'; document.getElementById('tab-content-pick').style.display=t==='pick'?'block':'none'; document.getElementById('tab-content-single').style.display=t==='single'?'block':'none'; }
      window.renderEasySetup = () => {
        const pool=document.getElementById('pool-container'); 
        const av=window.allMembers.filter(m=>!window.localMembers.some(l=>l[0]===m.nick));
        pool.innerHTML=av.map(m=>`<div class="pool-chip ${getJobKey(m.job)} ${window.selectedNicks.includes(m.nick)?'selected':''}" onclick="togPool('${m.nick}')"><div class="chip-del-btn" onclick="delPool(event,'${m.nick}')">Ã—</div><span class="chip-name">${m.nick}</span><span class="chip-sub">${m.job}</span></div>`).join('');
      }
      window.togPool = (n) => { const i=window.selectedNicks.indexOf(n); if(i>-1)window.selectedNicks.splice(i,1); else window.selectedNicks.push(n); renderEasySetup(); }
      window.delPool = (e,n) => { e.stopPropagation(); if(confirm('ì˜êµ¬ì‚­ì œ?')){ window.allMembers=window.allMembers.filter(m=>m.nick!==n); saveAllData(); renderEasySetup(); } }
      window.addSelectedToParty = (p) => { window.selectedNicks.forEach(n=>{ const m=window.allMembers.find(x=>x.nick===n); if(m)window.localMembers.push([m.nick,m.job,m.level,p]); }); window.selectedNicks=[]; saveAllData(); loadMembers(); renderEasySetup(); }
      window.submitNewMember = () => { window.allMembers.push({nick:document.getElementById('new-nick').value, job:document.getElementById('new-job').value, level:document.getElementById('new-level').value}); saveAllData(); renderEasySetup(); }

      /* [ê³µí†µ] */
      window.tryLogin = () => { const n=document.getElementById('login-nick').value, p=document.getElementById('login-pw').value; if(n==='ê´€ë¦¬ì'&&p===window.sysConfig.pwAdmin)authS(n,'admin'); else if(p===window.sysConfig.pwMember)authS(n,'member'); else if(p===window.sysConfig.pwGuest)authS(n,'guest'); else alert('ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜'); }
      function authS(n,r) { window.currentUser=n; window.userRole=r; window.isAdmin=(r==='admin'); document.getElementById('login-view').style.display='none'; document.getElementById('main-app').style.display='block'; document.getElementById('user-display').innerText=n; const b=document.getElementById('role-badge'); b.innerText=(r==='admin'?'ê´€ë¦¬ì':r==='member'?'ê³µëŒ€ì›':'ì†ë‹˜'); b.style.background=(r==='admin'?'#ff4d4f':r==='member'?'#1890ff':'#52c41a'); if(window.isAdmin){ document.getElementById('add-member-btn').style.display='block'; document.getElementById('reset-party-btn').style.display='block'; } refreshUI(); }
      window.getTodayStr = () => new Date().toISOString().split('T')[0];
      window.genTable = (id,ths) => `<table class="record-table"><thead><tr>${ths.map(t=>`<th>${t}</th>`).join('')}</tr></thead><tbody id="${id}"></tbody></table>`;
      window.showContent = (t,h) => { document.getElementById('modal-title').innerText=t; document.getElementById('modal-content').innerHTML=h; document.getElementById('modal-overlay').style.display='flex'; }
      window.closeModal = (e) => { if(e.target.classList.contains('modal-overlay'))e.target.style.display='none'; }
      window.deleteRecord = (t,i) => { if(confirm('ì‚­ì œ?')){ window.appData[t].splice(i,1); saveAllData(); refreshUI(); } }
      window.handleEnter = (e) => { if(e.keyCode===13)tryLogin(); }
    </script>
  </body>
</html>
